# JellyCore Docker Compose
# Oracle V2 + ChromaDB + NanoClaw (unified)

services:
  # ChromaDB - Vector database for semantic search (internal only, auth required)
  # ChromaDB 0.4.24: REST API. Oracle computes embeddings client-side
  # using @chroma-core/default-embed (all-MiniLM-L6-v2, 384-dim)
  chromadb:
    image: chromadb/chroma:0.4.24
    container_name: jellycore-chromadb
    restart: unless-stopped
    mem_limit: 512m
    # No port mapping — only accessible within jellycore-internal network
    volumes:
      - chromadb-data:/chroma/chroma
    environment:
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
      - CHROMA_SERVER_AUTHN_PROVIDER=chromadb.auth.token_authn.TokenAuthenticationServerProvider
      - CHROMA_SERVER_AUTHN_CREDENTIALS=${CHROMA_AUTH_TOKEN}
      - CHROMA_AUTH_TOKEN_TRANSPORT_HEADER=Authorization
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=False
    networks:
      - jellycore-internal
    healthcheck:
      test: ["CMD-SHELL", "grep -q ':1F40 ' /proc/net/tcp"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # Oracle V2 - Knowledge engine (independent HTTP service)
  oracle:
    build:
      context: ./oracle-v2
      dockerfile: Dockerfile
    container_name: jellycore-oracle
    restart: unless-stopped
    mem_limit: 1g  # Need 1g+ for ONNX embedding model (all-MiniLM-L6-v2)
    ports:
      - "47778:47778"
    volumes:
      - oracle-data:/data/oracle
      # Mount full ψ/memory so indexer + handleLearn can access ψ/memory/learnings, resonance, retrospectives
      - ./oracle-v2/ψ/memory:/data/knowledge/ψ/memory
      - oracle-knowledge-private:/data/knowledge/private
    environment:
      - ORACLE_PORT=47778
      - ORACLE_REPO_ROOT=/data/knowledge
      - ORACLE_DATA_DIR=/data/oracle
      - CHROMA_URL=http://chromadb:8000
      - CHROMA_AUTH_TOKEN=${CHROMA_AUTH_TOKEN}
      - THAI_NLP_URL=http://thai-nlp:8000
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - NODE_ENV=production
    networks:
      - jellycore-internal
    depends_on:
      chromadb:
        condition: service_healthy
      thai-nlp:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "bun", "-e", "const r = await fetch('http://localhost:47778/api/health'); process.exit(r.ok ? 0 : 1)"]
      interval: 30s
      timeout: 5s
      retries: 3

  # NanoClaw - AI orchestrator (spawns agent containers)
  nanoclaw:
    build:
      context: .
      dockerfile: Dockerfile.nanoclaw
    container_name: jellycore-nanoclaw
    restart: unless-stopped
    mem_limit: 1g
    volumes:
      # Docker socket — NanoClaw spawns agent containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Persistent state (sessions, database, auth)
      - nanoclaw-store:/app/nanoclaw/store
      - nanoclaw-data:/app/nanoclaw/data
      # Group workspaces (shared with agent containers)
      - ./groups:/app/nanoclaw/groups
    environment:
      # Channels: comma-separated (telegram, whatsapp). Default: telegram only
      - ENABLED_CHANNELS=${ENABLED_CHANNELS:-telegram}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      # Z.AI GLM Coding Plan — native Anthropic-compatible endpoint
      # https://docs.z.ai/devpack/tool/claude#manual-configuration
      - ANTHROPIC_AUTH_TOKEN=${ANTHROPIC_API_KEY}
      - ANTHROPIC_BASE_URL=https://api.z.ai/api/anthropic
      - ANTHROPIC_DEFAULT_SONNET_MODEL=GLM-4.7
      - ANTHROPIC_DEFAULT_HAIKU_MODEL=GLM-4.5-Air
      - ANTHROPIC_DEFAULT_OPUS_MODEL=GLM-4.7
      - API_TIMEOUT_MS=3000000
      # Oracle (containers on jellycore-internal network use DNS name)
      - ORACLE_API_URL=http://oracle:47778
      - ORACLE_AUTH_TOKEN=${ORACLE_AUTH_TOKEN}
      # Security
      - JELLYCORE_AUTH_PASSPHRASE=${JELLYCORE_AUTH_PASSPHRASE}
      - JELLYCORE_IPC_SECRET=${JELLYCORE_IPC_SECRET}
      # Misc
      - TZ=${TZ:-Asia/Bangkok}
      - ASSISTANT_NAME=${ASSISTANT_NAME:-Andy}
      - CONTAINER_IMAGE=${CONTAINER_IMAGE:-nanoclaw-agent:latest}
      # Docker network for agent containers to join
      - DOCKER_NETWORK=jellycore_jellycore-internal
    networks:
      - jellycore-internal
    depends_on:
      oracle:
        condition: service_healthy

  # Thai NLP Sidecar - PyThaiNLP wrapper for Thai text processing
  thai-nlp:
    build: ./thai-nlp-sidecar
    container_name: jellycore-thai-nlp
    restart: unless-stopped
    mem_limit: 256m
    # No port mapping in dev — only accessible within jellycore-internal network
    # For local testing: uncomment the ports line below
    # ports:
    #   - "47780:8000"
    environment:
      - PYTHAINLP_DATA_DIR=/data/pythainlp
    volumes:
      - thai-nlp-data:/data/pythainlp
    networks:
      - jellycore-internal
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 45s

volumes:
  chromadb-data:
    driver: local
  oracle-data:
    driver: local
  oracle-knowledge-private:
    driver: local
  nanoclaw-store:
    driver: local
  nanoclaw-data:
    driver: local
  thai-nlp-data:
    driver: local

networks:
  jellycore-internal:
    driver: bridge
