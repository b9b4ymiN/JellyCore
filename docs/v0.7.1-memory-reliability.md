# JellyCore v0.7.1 â€” Memory Reliability & Agent Monitoring

> **Status**: ğŸ”„ In Progress  
> **Date**: 2026-02-18  
> **Goal**: à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² Agent à¸¥à¸·à¸¡à¸„à¸§à¸²à¸¡à¸ˆà¸³ + à¹„à¸¡à¹ˆà¸•à¸­à¸šà¸ªà¸™à¸­à¸‡, à¹€à¸à¸´à¹ˆà¸¡ Admin Dashboard  
> **Target**: Oracle Cloud A1.Flex (ARM, 4 CPU / 24 GB RAM)  
> **Prerequisite**: v0.7.0 (Five-Layer Memory schema) deployed

---

## Root Cause Analysis

### à¸›à¸±à¸à¸«à¸² 1: Agent à¹„à¸¡à¹ˆà¸ˆà¸”à¸ˆà¸³ / à¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰ Oracle

| Finding | Impact | Location |
|---------|--------|----------|
| `PromptBuilder` à¸–à¸¹à¸à¹€à¸‚à¸µà¸¢à¸™à¹„à¸§à¹‰à¹à¸•à¹ˆ**à¹„à¸¡à¹ˆà¹€à¸„à¸¢à¸–à¸¹à¸à¹€à¸£à¸µà¸¢à¸à¹ƒà¸Šà¹‰** | Agent à¹€à¸£à¸´à¹ˆà¸¡à¸—à¸¸à¸ session à¸”à¹‰à¸§à¸¢à¸„à¸§à¸²à¸¡à¸ˆà¸³à¹€à¸›à¹‡à¸™à¸¨à¸¹à¸™à¸¢à¹Œ | `nanoclaw/src/prompt-builder.ts` (unused) |
| `PreCompact` hook à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸‡ filesystem à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ | Episodic memory à¹„à¸¡à¹ˆà¹€à¸„à¸¢à¸–à¸¹à¸à¹€à¸‚à¸µà¸¢à¸™à¸à¸¥à¸±à¸š Oracle | `agent-runner/src/index.ts` L156-187 |
| Memory instructions à¸­à¸¢à¸¹à¹ˆà¸—à¹‰à¸²à¸¢ CLAUDE.md | Agent à¸­à¸²à¸ˆà¹„à¸¡à¹ˆà¸­à¹ˆà¸²à¸™à¸–à¸¶à¸‡ / à¹„à¸¡à¹ˆà¸›à¸à¸´à¸šà¸±à¸•à¸´à¸•à¸²à¸¡ | `groups/global/CLAUDE.md` |
| à¹„à¸¡à¹ˆà¸¡à¸µ proactive context injection | Agent à¸•à¹‰à¸­à¸‡ "à¹€à¸¥à¸·à¸­à¸" à¹€à¸£à¸µà¸¢à¸ Oracle à¹€à¸­à¸‡ â€” Sonnet 4 à¹„à¸¡à¹ˆà¸—à¸³à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡ | design gap |

### à¸›à¸±à¸à¸«à¸² 2: Agent à¹„à¸¡à¹ˆà¸•à¸­à¸šà¸ªà¸™à¸­à¸‡ (Silent Failures)

| Failure Path | User Notified? | Location |
|-------------|----------------|----------|
| Container timeout (no output) | âŒ à¹„à¸¡à¹ˆà¸¡à¸µ | `container-runner.ts` L580 |
| Container spawn error | âŒ à¹„à¸¡à¹ˆà¸¡à¸µ | `container-runner.ts` L765 |
| Stdout parse failure | âŒ à¹„à¸¡à¹ˆà¸¡à¸µ | `container-runner.ts` L695 |
| Queue full (>20 groups) | âŒ à¹„à¸¡à¹ˆà¸¡à¸µ | `group-queue.ts` L100 |
| Max retries (5x) | âŒ à¹„à¸¡à¹ˆà¸¡à¸µ | `group-queue.ts` L278 |
| Budget offline | âœ… à¹à¸ˆà¹‰à¸‡ user | `index.ts` L228 |

---

## Implementation Plan

### Track A: Memory Reliability

#### A1. Compact Context Injection (PromptBuilder)

**à¸›à¸±à¸à¸«à¸² Context Bloat**: inject Oracle context à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡ = à¹€à¸à¸´à¹ˆà¸¡ tokens à¹ƒà¸™ prompt  
**à¸§à¸´à¸˜à¸µà¹à¸à¹‰**: **Token Budget System** â€” à¸ˆà¸³à¸à¸±à¸” Oracle context à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ **600 tokens** (~2,400 chars)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Oracle Context Budget: 600 tokens max       â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â”‚ User Model (L1)         â”‚ â‰¤ 150 tokens    â”‚
â”‚ â”‚ à¸Šà¸·à¹ˆà¸­, à¸ à¸²à¸©à¸², expertise   â”‚ (~3 lines)     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â”‚ Recent Episodes (L4)    â”‚ â‰¤ 200 tokens    â”‚
â”‚ â”‚ 2 episodes, 1-2 lines   â”‚ (summaries)    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â”‚ Relevant Knowledge (L3) â”‚ â‰¤ 250 tokens    â”‚
â”‚ â”‚ top 3 results, compact  â”‚ (titles+snip)  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Design Decisions**:
- **Skip-if-empty**: section à¸—à¸µà¹ˆ Oracle à¸•à¸­à¸š empty â†’ à¹„à¸¡à¹ˆ inject (0 tokens)
- **Truncation**: à¹à¸•à¹ˆà¸¥à¸° section à¸–à¸¹à¸ truncate à¸—à¸µà¹ˆ char limit
- **Timeout**: 3 à¸§à¸´à¸™à¸²à¸—à¸µà¸£à¸§à¸¡ parallel queries â†’ Oracle à¸Šà¹‰à¸²/à¸¥à¹ˆà¸¡ â†’ skip gracefully
- **Cache**: LRU 50 entries, 5 à¸™à¸²à¸—à¸µ TTL per group â†’ à¹„à¸¡à¹ˆ query Oracle à¸—à¸¸à¸ message
- **Format**: Compact XML â€” minimal tags

Example injected context (~400 tokens):
```xml
<ctx>
<user>à¸Šà¸·à¹ˆà¸­ Min, dev Python/TS, à¸Šà¸­à¸š concise responses, à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¹„à¸—à¸¢+EN</user>
<recent>
- 2h ago: à¹à¸à¹‰ bug Oracle search â€” fixed FTS5 tokenizer
- 1d ago: deploy v0.6.0 â€” all services healthy
</recent>
<knowledge>
- Oracle hybrid search à¹ƒà¸Šà¹‰ FTS5+ChromaDB, weight à¸›à¸£à¸±à¸šà¸•à¸²à¸¡ query type
- Agent container limit 512MB, timeout 30min
</knowledge>
</ctx>
```

**à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸š**: agent context 200K tokens â†’ à¹€à¸à¸´à¹ˆà¸¡à¹à¸„à¹ˆ **0.3%**

**Files**:
- `nanoclaw/src/prompt-builder.ts` â€” rewrite with token budget
- `nanoclaw/src/index.ts` â€” activate before container spawn
- `nanoclaw/src/router.ts` â€” prepend context

#### A2. Auto-Episodic Recording

à¹€à¸¡à¸·à¹ˆà¸­ container à¸ˆà¸š â†’ à¸ªà¸£à¹‰à¸²à¸‡ episode summary à¸ˆà¸²à¸ conversation â†’ POST à¹„à¸› Oracle

- Simple extraction (à¹„à¸¡à¹ˆà¹€à¸£à¸µà¸¢à¸ LLM): user messages + final response â†’ truncate 200 words
- Fire-and-forget: à¹„à¸¡à¹ˆ block container exit
- Dedup: hash check

**Files**:
- `nanoclaw/container/agent-runner/src/index.ts` â€” add `recordEpisode()`

#### A3. Strengthen Memory Prompts

- à¸¢à¹‰à¸²à¸¢ memory instructions à¸‚à¸¶à¹‰à¸™à¸•à¹‰à¸™ CLAUDE.md
- à¹€à¸à¸´à¹ˆà¸¡ mandatory checklist
- "à¸ˆà¸³à¹„à¸§à¹‰/remember" â†’ `oracle_learn` à¸—à¸±à¸™à¸—à¸µ
- "à¸­à¹ˆà¸²à¸™ `<ctx>` block à¹€à¸ªà¸¡à¸­ â€” à¸™à¸µà¹ˆà¸„à¸·à¸­à¸„à¸§à¸²à¸¡à¸ˆà¸³à¸‚à¸­à¸‡à¸„à¸¸à¸“"

**Files**: `groups/global/CLAUDE.md`, `groups/global/SOUL.md`

#### A4. Fix main CLAUDE.md

à¸¥à¸š `/workspace/project` reference à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡

---

### Track B: Response Reliability & Dashboard

#### B1. Error Notification

à¸—à¸¸à¸ failure path â†’ à¸ªà¹ˆà¸‡ Telegram message à¹à¸ˆà¹‰à¸‡ user

| Failure | Message |
|---------|---------|
| Container timeout | "â³ à¸£à¸°à¸šà¸šà¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸™à¸²à¸™ à¸à¸³à¸¥à¸±à¸‡ retry..." |
| Spawn error | "âš ï¸ à¸£à¸°à¸šà¸šà¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¹„à¸¡à¹ˆà¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ" |
| Queue full | "â³ à¸„à¸´à¸§à¹€à¸•à¹‡à¸¡ à¸à¸£à¸¸à¸“à¸²à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ" |
| Max retries | "âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¹„à¸”à¹‰à¸«à¸¥à¸±à¸‡ 5 à¸„à¸£à¸±à¹‰à¸‡" |

**Files**: `nanoclaw/src/index.ts`, `nanoclaw/src/group-queue.ts`

#### B2. NanoClaw Health Endpoint

Node.js built-in HTTP (port 47779, internal):
```
GET /health  â†’ { status, uptime, version }
GET /status  â†’ { activeContainers, queueDepth, groups, resources, recentErrors }
```

**Files**: `nanoclaw/src/index.ts`, `docker-compose.yml`

#### B3. Oracle Proxy + Admin Dashboard

**Strategy**: à¸•à¹ˆà¸­à¸¢à¸­à¸” Oracle React frontend â€” à¹„à¸¡à¹ˆà¹€à¸à¸´à¹ˆà¸¡ service

**Proxy**: `GET /api/nanoclaw/status` â†’ fetch NanoClaw internal

**Pages** (lazy-loaded):
1. `/admin` â€” NanoClaw status (containers, queue, resources, errors)
2. `/admin/memory` â€” Memory manager (user model, episodes, knowledge CRUD)
3. `/admin/logs` â€” Log viewer

**Bundle optimization**: Lazy-load Three.js + admin pages â†’ â‰¤300KB initial

**Files**: `oracle-v2/src/server.ts`, `oracle-v2/frontend/src/`

#### B4. Agent Container Resource Limits

`--memory=512m --cpus=1.0`, `MAX_CONCURRENT_CONTAINERS=2`

#### B5. Basic Auth for Admin

`ORACLE_AUTH_TOKEN` as Bearer for `/admin/*` + `/api/nanoclaw/*`

---

## Resource Budget (A1.Flex)

```
Infrastructure (2.0 CPU / 2.5 GB):
  ChromaDB      0.5 CPU /  512 MB
  Oracle V2     0.5 CPU / 1024 MB
  NanoClaw      1.0 CPU / 1024 MB

Agents (dynamic, max 2):
  Per agent:    1.0 CPU /  512 MB
  Max:          2.0 CPU / 1024 MB

Total peak:     4.0 CPU / 3.5 GB  (of 24 GB available)
```

## Execution Order

```
Phase 1 (Critical):  A1 â†’ A3 â†’ A2 â†’ B1
Phase 2 (Monitor):   B2 â†’ B3 â†’ B4 â†’ B5
Phase 3 (Cleanup):   A4
```

## Verification

- [ ] Memory: "à¸ˆà¸³à¹„à¸§à¹‰à¸§à¹ˆà¸²à¸Šà¸·à¹ˆà¸­ X" â†’ new session â†’ "à¸Šà¸·à¹ˆà¸­à¸­à¸°à¹„à¸£" â†’ à¸•à¸­à¸šà¸–à¸¹à¸
- [ ] Auto-episode: à¸„à¸¸à¸¢ 1 session â†’ `/api/episodic` â†’ à¸¡à¸µ summary
- [ ] Error notify: stop Oracle â†’ à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ â†’ à¹„à¸”à¹‰ error message
- [ ] Dashboard: `http://<ip>:47778/admin` â†’ à¹€à¸«à¹‡à¸™ status
- [ ] Memory mgr: `/admin/memory` â†’ CRUD user model
- [ ] Resource: `docker inspect` agent â†’ memory 512MB
- [ ] Context: inject â‰¤ 600 tokens (logged)
