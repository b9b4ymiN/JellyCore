# v0.8.0 â€” Phase 5: Production Polish & Intelligence Infrastructure

> **Type:** Major â€” à¹€à¸à¸´à¹ˆà¸¡ infrastructure layer à¹ƒà¸«à¸¡à¹ˆ à¸›à¸£à¸±à¸š pipeline à¸—à¸±à¹‰à¸‡ NanoClaw + Oracle  
> **Scope:** Context Mastery, Streaming UX, Cost Intelligence, Observability, Skills System  
> **Risk:** High â€” à¸à¸£à¸°à¸—à¸šà¸—à¸±à¹‰à¸‡ NanoClaw (Body) à¹à¸¥à¸° Oracle (Brain) à¸à¸£à¹‰à¸­à¸¡à¸à¸±à¸™  
> **Est. Effort:** ~4-5 à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ  
> **Prerequisites:** v0.7.0 (Phase 4 â€” Five-Layer Memory System) âœ… deployed  
> **Pillars:** Pillar 2 (Context Mastery), Pillar 3 (Cost Intelligence), Pillar 4 (Streaming UX),  
>   Pillar 5 (Agent Loop), Pillar 6 (Skills), Pillar 7 (Observability)  
> **Source:** [BEYOND_OPENCLAW.md](BEYOND_OPENCLAW.md) roadmap items 5.7â€“5.11 + Phase 6 previews

---

## Background

### à¸—à¸³à¹„à¸¡à¸•à¹‰à¸­à¸‡à¸—à¸³ Phase à¸™à¸µà¹‰

v0.7.0 à¸—à¸³à¹ƒà¸«à¹‰ Oracle **à¸‰à¸¥à¸²à¸”à¸‚à¸¶à¹‰à¸™** à¸”à¹‰à¸§à¸¢ Five-Layer Memory  
à¹à¸•à¹ˆà¸£à¸°à¸šà¸šà¹‚à¸”à¸¢à¸£à¸§à¸¡à¸¢à¸±à¸‡à¸‚à¸²à¸” **"à¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™à¸¡à¸·à¸­à¸­à¸²à¸Šà¸µà¸"** à¸—à¸µà¹ˆà¸ˆà¸°à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸ˆà¸£à¸´à¸‡à¸£à¸°à¸¢à¸°à¸¢à¸²à¸§:

1. **Context à¸«à¸¡à¸”à¹€à¸£à¹‡à¸§** â€” à¹„à¸¡à¹ˆà¸¡à¸µ auto-compaction, à¹„à¸¡à¹ˆà¸¡à¸µ memory flush â†’ conversation à¸¢à¸²à¸§ à¹† AI à¸¥à¸·à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸­à¸™à¸•à¹‰à¸™
2. **à¹„à¸¡à¹ˆà¸¡à¸µ streaming** â€” user à¸•à¹‰à¸­à¸‡à¸£à¸­ 10-30 à¸§à¸´à¸™à¸²à¸—à¸µ à¸à¸§à¹ˆà¸²à¸ˆà¸°à¹€à¸«à¹‡à¸™à¸„à¸³à¸•à¸­à¸š â†’ UX à¹à¸¢à¹ˆ
3. **à¹„à¸¡à¹ˆà¸¡à¸µ budget control** â€” à¸„à¹ˆà¸²à¹ƒà¸Šà¹‰à¸ˆà¹ˆà¸²à¸¢à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸ˆà¸³à¸à¸±à¸” à¸–à¹‰à¸² model à¹à¸à¸‡à¸§à¸´à¹ˆà¸‡à¸¢à¸²à¸§à¸­à¸²à¸ˆ overshoot
4. **à¹„à¸¡à¹ˆà¸¡à¸µ tracing** â€” à¹€à¸¡à¸·à¹ˆà¸­ response à¸Šà¹‰à¸² à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸§à¹ˆà¸²à¸Šà¹‰à¸²à¸•à¸£à¸‡à¹„à¸«à¸™ (Oracle? Container? LLM?)
5. **à¹„à¸¡à¹ˆà¸¡à¸µ self-diagnosis** â€” à¸•à¹‰à¸­à¸‡ SSH à¹€à¸‚à¹‰à¸²à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹ health à¸£à¸°à¸šà¸š
6. **à¹„à¸¡à¹ˆà¸¡à¸µ skill system** â€” à¹€à¸à¸´à¹ˆà¸¡à¸„à¸§à¸²à¸¡à¸ªà¸²à¸¡à¸²à¸£à¸– agent à¸•à¹‰à¸­à¸‡à¹à¸à¹‰ code à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡

### à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸ˆà¸°à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™

```
v0.7.0 State (à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™)                    v0.8.0 Target
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŒ No compaction                    â†’  âœ… Auto-compaction + memory flush
âŒ No streaming (wait 10-30s)       â†’  âœ… Block streaming + status indicators  
âŒ Basic cost tracking              â†’  âœ… Budget enforcement + auto-downgrade
âŒ No request tracing               â†’  âœ… Per-request trace with timeline
âŒ Console-only logging             â†’  âœ… Structured trace + /doctor
âŒ Hardcoded agent behavior         â†’  âœ… Hot-loadable skill system
âŒ No NanoClaw health check         â†’  âœ… /health endpoint + Docker health
```

### à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸à¸±à¸™à¸˜à¹Œà¸à¸±à¸š BEYOND_OPENCLAW Pillars

| Part | Pillar | à¹€à¸™à¸·à¹‰à¸­à¸«à¸² |
|------|--------|---------|
| Part A | Pillar 2 | Context Mastery â€” Auto-Compaction + Memory Flush + Session Pruning |
| Part B | Pillar 4 | Streaming & Response UX â€” Block Streaming + Status Indicators |
| Part C | Pillar 3 | Cost Intelligence â€” Budget System + Model Auto-Downgrade |
| Part D | Pillar 7 | Observability â€” Request Tracing + /doctor + Knowledge Quality |
| Part E | Pillar 5 | Agent Loop â€” Reply Shaping + NO_REPLY + Tool Sanitization |
| Part F | Pillar 6 | Skills & Extensibility â€” Standardized Skill Format + Hot Reload |

---

## Dependency Graph

```
Part A: Context Mastery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚
Part B: Streaming UX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                      â”œâ”€â”€â†’ Part E: Agent Loop (à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰ A+B)
Part C: Cost Intelligence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                      â”‚
Part D: Observability â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                      â”‚
Part F: Skills System (independent) â”€â”€â”˜


à¹à¸™à¸°à¸™à¸³à¸¥à¸³à¸”à¸±à¸š:
  Wave 1: Part C (Cost) + Part D (Observability) + Part F (Skills)  â† parallel, independent
  Wave 2: Part A (Context Mastery)                                   â† à¹ƒà¸Šà¹‰ D.tracing
  Wave 3: Part B (Streaming UX)                                      â† à¹ƒà¸Šà¹‰ A.compaction
  Wave 4: Part E (Agent Loop)                                        â† à¹ƒà¸Šà¹‰à¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡à¸‚à¹‰à¸²à¸‡à¸šà¸™
```

---

## Part A â€” Context Mastery (Pillar 2)

> **à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢:** à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ AI "à¸¥à¸·à¸¡" à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ conversation à¸¢à¸²à¸§  
> **à¹à¸à¹‰à¸›à¸±à¸à¸«à¸²:** Context window à¹€à¸•à¹‡à¸¡ â†’ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸²à¸¢, à¹„à¸¡à¹ˆà¸¡à¸µ memory flush  
> **à¸—à¸µà¹ˆà¸—à¸³:** NanoClaw (container-runner.ts, prompt-builder.ts)  
> **Effort:** Large (~3-4 à¸§à¸±à¸™)

### A.1 â€” Context Window Monitor

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** NanoClaw à¸ªà¹ˆà¸‡ message à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸‚à¹‰à¸² container à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸•à¸£à¸§à¸ˆ context size  
**à¸›à¸±à¸à¸«à¸²:** à¸–à¹‰à¸² conversation à¸¢à¸²à¸§à¸¡à¸²à¸ â†’ context window à¹€à¸•à¹‡à¸¡ â†’ LLM truncate à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¹ˆà¸²à¹€à¸­à¸‡ â†’ AI à¸¥à¸·à¸¡  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** Monitor context size à¸—à¸¸à¸ turn, trigger compaction à¸à¹ˆà¸­à¸™à¹€à¸•à¹‡à¸¡

```
Context Window Management:

  à¸—à¸¸à¸ message à¸—à¸µà¹ˆ user à¸ªà¹ˆà¸‡à¹€à¸‚à¹‰à¸²à¸¡à¸²:
  
  â‘  NanoClaw à¸„à¸³à¸™à¸§à¸“ estimated tokens à¸‚à¸­à¸‡ context à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
     - system prompt + conversation history + Oracle context
     - estimation: chars Ã· 4 (Thai chars Ã· 2 à¹€à¸à¸£à¸²à¸° tokenize à¸•à¹ˆà¸²à¸‡à¸à¸±à¸™)
     - Thai detection: à¸–à¹‰à¸² >50% à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£à¹€à¸›à¹‡à¸™ [\u0E00-\u0E7F] â†’ à¹ƒà¸Šà¹‰ Ã·2
     
  â‘¡ à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸š thresholds:
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Context Usage         â”‚  Action                              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  < 70% window          â”‚  âœ… Normal â€” à¸ªà¹ˆà¸‡à¹€à¸‚à¹‰à¸² container à¸›à¸à¸•à¸´   â”‚
  â”‚  70-85% window         â”‚  âš ï¸ Memory Flush â€” à¸šà¸­à¸ agent à¹€à¸‚à¸µà¸¢à¸™   â”‚
  â”‚                        â”‚  à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸„à¸±à¸à¸¥à¸‡ Oracle à¸à¹ˆà¸­à¸™            â”‚
  â”‚  85-95% window         â”‚  ğŸ”¶ Compaction â€” à¸ªà¸£à¸¸à¸› history à¹€à¸à¹ˆà¸²    â”‚
  â”‚                        â”‚  â†’ à¹€à¸à¹‡à¸šà¹ƒà¸™ Oracle â†’ à¸•à¸±à¸” context        â”‚
  â”‚  > 95% window          â”‚  ğŸ”´ Emergency â€” hard trim à¸—à¸´à¹‰à¸‡ tool   â”‚
  â”‚                        â”‚  results à¹€à¸à¹ˆà¸² + system prompt trim    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Context Window Sizes (configurable):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
  â”‚  Model              â”‚  Context Window   â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  claude-sonnet-4    â”‚  200,000 tokens   â”‚
  â”‚  claude-haiku       â”‚  200,000 tokens   â”‚
  â”‚  glm-4.7            â”‚  128,000 tokens   â”‚
  â”‚  glm-4.5-air        â”‚  128,000 tokens   â”‚
  â”‚  default fallback   â”‚  100,000 tokens   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Config à¹ƒà¸«à¸¡à¹ˆà¹ƒà¸™ NanoClaw:**

```typescript
// nanoclaw/src/config.ts â€” à¹€à¸à¸´à¹ˆà¸¡
interface ContextConfig {
  flushThreshold: number;       // 0.70 â€” trigger memory flush
  compactionThreshold: number;  // 0.85 â€” trigger compaction
  emergencyThreshold: number;   // 0.95 â€” hard trim
  thaiCharRatio: number;        // 2.0 â€” Thai chars Ã· 2
  defaultCharRatio: number;     // 4.0 â€” English chars Ã· 4
  maxContextWindow: Record<string, number>;  // model â†’ tokens
}
```

### A.2 â€” Memory Flush (Pre-Compaction)

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** à¹„à¸¡à¹ˆà¸¡à¸µ â€” à¹€à¸¡à¸·à¹ˆà¸­ context à¹€à¸•à¹‡à¸¡ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸²à¸¢à¹„à¸›à¹€à¸¥à¸¢  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** à¸à¹ˆà¸­à¸™ compact, à¸ªà¸±à¹ˆà¸‡ agent "à¹€à¸‚à¸µà¸¢à¸™à¸ªà¸´à¹ˆà¸‡à¸ªà¸³à¸„à¸±à¸à¸¥à¸‡ Oracle à¸à¹ˆà¸­à¸™"

```
Memory Flush Protocol:

  à¹€à¸¡à¸·à¹ˆà¸­ context à¸–à¸¶à¸‡ 70% threshold:
  
  â‘  NanoClaw inject "Memory Flush Instruction" à¹€à¸›à¹‡à¸™ system message:
  
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  [SYSTEM â€” Memory Flush]                                  â”‚
     â”‚                                                           â”‚
     â”‚  Context window à¹ƒà¸à¸¥à¹‰à¹€à¸•à¹‡à¸¡ (73%) â€” à¸à¸£à¸¸à¸“à¸²à¹€à¸‚à¸µà¸¢à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸„à¸±à¸    â”‚
     â”‚  à¸¥à¸‡ Oracle à¸à¹ˆà¸­à¸™à¸—à¸µà¹ˆ conversation à¸ˆà¸°à¸–à¸¹à¸ compact:             â”‚
     â”‚                                                           â”‚
     â”‚  1. à¸‚à¹‰à¸­à¹€à¸—à¹‡à¸ˆà¸ˆà¸£à¸´à¸‡à¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆ user à¹à¸Šà¸£à¹Œ â†’ oracle_learn            â”‚
     â”‚  2. preferences/expertise â†’ oracle_user_model_update       â”‚
     â”‚  3. à¸§à¸´à¸˜à¸µà¸—à¸³à¸‡à¸²à¸™à¸—à¸µà¹ˆà¸„à¹‰à¸™à¸à¸š â†’ oracle_procedural_learn            â”‚
     â”‚  4. à¸ªà¸£à¸¸à¸›à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸„à¸¸à¸¢à¸à¸±à¸™ â†’ oracle_episodic_record              â”‚
     â”‚                                                           â”‚
     â”‚  à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¸­à¸°à¹„à¸£à¸•à¹‰à¸­à¸‡à¹€à¸‚à¸µà¸¢à¸™ â†’ à¸•à¸­à¸š NO_REPLY                     â”‚
     â”‚  à¸«à¸¥à¸±à¸‡à¹€à¸‚à¸µà¸¢à¸™à¹€à¸ªà¸£à¹‡à¸ˆ â†’ à¸•à¸­à¸š NO_REPLY                            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â‘¡ Agent à¸—à¸³à¸‡à¸²à¸™:
     - à¹€à¸£à¸µà¸¢à¸ Oracle MCP tools à¹€à¸à¸·à¹ˆà¸­ store à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸„à¸±à¸
     - à¸•à¸­à¸š "NO_REPLY" â†’ NanoClaw à¹„à¸¡à¹ˆà¸ªà¹ˆà¸‡à¸­à¸°à¹„à¸£à¹ƒà¸«à¹‰ user
     
  â‘¢ NanoClaw:
     - à¸•à¸£à¸§à¸ˆ output === "NO_REPLY" â†’ skip sending to channel
     - Log: "[flush] agent saved 3 items to Oracle"
     - à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£ compaction (A.3) à¸•à¹ˆà¸­à¸–à¹‰à¸²à¸¢à¸±à¸‡ > 85%
```

**Flow Diagram:**

```
User sends message
        â”‚
        â–¼
  NanoClaw: estimate context
        â”‚
        â”œâ”€â”€ < 70% â”€â”€â†’ normal response
        â”‚
        â”œâ”€â”€ 70-85% â”€â”€â†’ â‘  inject flush instruction
        â”‚                â‘¡ agent writes to Oracle
        â”‚                â‘¢ agent returns NO_REPLY
        â”‚                â‘£ check again:
        â”‚                   â”œâ”€â”€ < 85% â†’ normal response
        â”‚                   â””â”€â”€ >= 85% â†’ compaction (A.3)
        â”‚
        â””â”€â”€ >= 85% â”€â”€â†’ compaction (A.3) immediately
```

### A.3 â€” Auto-Compaction

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** à¹„à¸¡à¹ˆà¸¡à¸µ â€” context à¹€à¸•à¹‡à¸¡à¹à¸¥à¹‰à¸§ LLM à¸•à¸±à¸”à¹€à¸­à¸‡  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** NanoClaw à¸ªà¸£à¸¸à¸› conversation à¹€à¸à¹ˆà¸² â†’ à¹€à¸à¹‡à¸šà¹ƒà¸™ Oracle â†’ à¸•à¸±à¸” context â†’ à¸ªà¹ˆà¸‡ resume

```
Compaction Protocol:

  à¹€à¸¡à¸·à¹ˆà¸­ context à¸¢à¸±à¸‡à¹€à¸à¸´à¸™ 85% à¸«à¸¥à¸±à¸‡ flush:
  
  â‘  NanoClaw extract conversation history:
     - à¹à¸¢à¸ messages à¹€à¸›à¹‡à¸™ 2 à¸ªà¹ˆà¸§à¸™:
       â— recent (last 5 turns) â†’ à¹€à¸à¹‡à¸šà¹„à¸§à¹‰ (à¹„à¸¡à¹ˆ compact)  
       â— old (à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­) â†’ à¸ˆà¸°à¸–à¸¹à¸ compact
  
  â‘¡ à¸ªà¸£à¹‰à¸²à¸‡ compaction summary (à¹ƒà¸Šà¹‰ LLM â€” Haiku tier):
     - à¸ªà¹ˆà¸‡ old messages â†’ LLM à¸ªà¸£à¸¸à¸›à¹€à¸›à¹‡à¸™ structured summary:
     
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  Compaction Summary                                    â”‚
     â”‚                                                        â”‚
     â”‚  Topics: [docker deployment, oracle memory system]     â”‚
     â”‚  Key Facts:                                            â”‚
     â”‚    - User à¸à¸³à¸¥à¸±à¸‡à¸—à¸³ v0.8.0 Phase 5                       â”‚
     â”‚    - à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ streaming + cost tracking                 â”‚
     â”‚    - Deploy à¸šà¸™ Docker Compose 4 services               â”‚
     â”‚  Decisions Made:                                        â”‚
     â”‚    - à¹ƒà¸Šà¹‰ Hono.js à¸ªà¸³à¸«à¸£à¸±à¸š API server                     â”‚
     â”‚    - à¹ƒà¸Šà¹‰ bun:sqlite à¹à¸—à¸™ better-sqlite3                 â”‚
     â”‚  Open Items:                                            â”‚
     â”‚    - à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸—à¸³ Part B streaming                      â”‚
     â”‚  User Preferences Observed:                             â”‚
     â”‚    - à¸Šà¸­à¸šà¸„à¸³à¸•à¸­à¸š concise, à¹€à¸™à¹‰à¸™ bullet points              â”‚
     â”‚    - à¹ƒà¸Šà¹‰à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ ~90%                                   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     
  â‘¢ Store summary à¸¥à¸‡ Oracle:
     - oracle_episodic_record(summary) â†’ episodic layer
     - à¸–à¹‰à¸²à¸¡à¸µ facts à¹ƒà¸«à¸¡à¹ˆ â†’ oracle_learn (auto)
     
  â‘£ Replace old turns à¸”à¹‰à¸§à¸¢ compact summary:
     - context à¹ƒà¸«à¸¡à¹ˆ = system prompt + compact summary + recent 5 turns
     - estimated tokens à¸„à¸§à¸£à¸¥à¸”à¸¥à¸‡ 50-70%
     
  â‘¤ Retry user's original message à¸”à¹‰à¸§à¸¢ compacted context:
     - à¸–à¹‰à¸² user à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡ â†’ à¸„à¸³à¸–à¸²à¸¡à¹€à¸”à¸´à¸¡à¸¢à¸±à¸‡à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ recent turns
     - Agent à¸•à¸­à¸šà¸›à¸à¸•à¸´ â€” user à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸§à¹ˆà¸²à¸¡à¸µ compaction à¹€à¸à¸´à¸”à¸‚à¸¶à¹‰à¸™
```

**Compaction Limits:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Parameter              â”‚  Value          â”‚  Reason          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Min turns to compact   â”‚  10             â”‚  à¸­à¸¢à¹ˆà¸² compact    â”‚
â”‚                         â”‚                 â”‚  à¸–à¹‰à¸² history à¸ªà¸±à¹‰à¸™ â”‚
â”‚  Keep recent turns      â”‚  5              â”‚  context à¸¥à¹ˆà¸²à¸ªà¸¸à¸”   â”‚
â”‚  Max summary tokens     â”‚  2,000          â”‚  summary à¸•à¹‰à¸­à¸‡à¸ªà¸±à¹‰à¸™ â”‚
â”‚  Max compactions/sessionâ”‚  3              â”‚  à¸–à¹‰à¸² 3 à¸„à¸£à¸±à¹‰à¸‡à¹à¸¥à¹‰à¸§   â”‚
â”‚                         â”‚                 â”‚  â†’ warn + reset   â”‚
â”‚  Compaction model       â”‚  Haiku          â”‚  à¸–à¸¹à¸ + à¹€à¸£à¹‡à¸§       â”‚
â”‚  Compaction timeout     â”‚  15 seconds     â”‚  à¸•à¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¸Šà¹‰à¸²à¸¡à¸²à¸    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### A.4 â€” Session Pruning

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** Tool results à¸—à¸¸à¸ turn à¸¢à¸±à¸‡à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ context à¸•à¸¥à¸­à¸” â†’ à¹ƒà¸Šà¹‰ tokens à¸¡à¸²à¸  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** Trim tool results à¹€à¸à¹ˆà¸²à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´ à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸‡à¹€à¸‚à¹‰à¸² container

```
Pruning Strategy (à¸—à¸³à¸—à¸¸à¸ turn à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸‡ LLM):

  à¸ªà¸³à¸«à¸£à¸±à¸šà¸—à¸¸à¸ tool result à¹ƒà¸™ conversation history:
  
  â‘  Tool results > 50,000 chars â†’ soft-trim:
     - à¹€à¸à¹‡à¸š head 1,500 chars + tail 1,500 chars  
     - à¹à¸—à¸£à¸ "... (truncated from {N} chars â€” full output available in earlier response)"
     
  â‘¡ Tool results à¸—à¸µà¹ˆà¹€à¸à¹ˆà¸²à¸¡à¸²à¸ (> 3 assistant turns ago) â†’ hard-clear:
     - à¹à¸—à¸™à¸”à¹‰à¸§à¸¢ "[Tool result cleared â€” see earlier in conversation]"
     
  â‘¢ à¸«à¹‰à¸²à¸¡à¸•à¸±à¸”:
     - user messages
     - assistant text messages
     - image blocks
     - system messages
  
  Savings Estimate:
  - Average tool result: ~5,000 chars â†’ 1,250 tokens
  - Pruning after 3 turns: save ~3,750 tokens per tool call
  - For 10-tool conversation: save ~37,500 tokens (~$0.11 at Sonnet rate)
```

**Implementation Location:**

```
nanoclaw/src/context-manager.ts (à¹„à¸Ÿà¸¥à¹Œà¹ƒà¸«à¸¡à¹ˆ):

  export class ContextManager {
    estimateTokens(messages: Message[], model: string): number
    shouldFlush(tokenCount: number, model: string): boolean
    shouldCompact(tokenCount: number, model: string): boolean
    pruneToolResults(messages: Message[]): Message[]
    generateCompactionSummary(oldMessages: Message[]): Promise<string>
    compact(messages: Message[], model: string): Promise<Message[]>
  }
```

### A.5 â€” Anticipatory Context Prefetch

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** Oracle context à¸”à¸¶à¸‡à¹€à¸‰à¸à¸²à¸°à¸•à¸­à¸™ user à¸–à¸²à¸¡ â†’ cold start à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** Prefetch context à¸—à¸µà¹ˆà¸™à¹ˆà¸²à¸ˆà¸°à¹ƒà¸Šà¹‰ à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ user à¸­à¹ˆà¸²à¸™à¸„à¸³à¸•à¸­à¸š

```
Prefetch Engine:

  à¹€à¸¡à¸·à¹ˆà¸­ agent à¸•à¸­à¸šà¹€à¸ªà¸£à¹‡à¸ˆ (async, à¹„à¸¡à¹ˆ block response):
  
  â‘  à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ topics à¸—à¸µà¹ˆà¸à¸³à¸¥à¸±à¸‡à¸„à¸¸à¸¢:
     - extract à¸ˆà¸²à¸ recent 3 messages
     - à¹ƒà¸Šà¹‰ concepts à¸ˆà¸²à¸ Oracle search results à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
     
  â‘¡ Oracle prefetch query:
     - à¸”à¸¶à¸‡ related concepts â†’ cache warm
     - à¸–à¹‰à¸²à¸à¸³à¸¥à¸±à¸‡à¸„à¸¸à¸¢ Docker â†’ prefetch Docker-related knowledge
     - à¸–à¹‰à¸²à¸à¸³à¸¥à¸±à¸‡à¸„à¸¸à¸¢ deploy â†’ prefetch deployment procedures
     
  â‘¢ à¹€à¸à¹‡à¸š prefetched context à¹ƒà¸™ LRU cache:
     - key: topic hash
     - TTL: 5 minutes (à¸ªà¸±à¹‰à¸™à¸à¸§à¹ˆà¸² search cache à¸›à¸à¸•à¸´)
     - Max entries: 50 (à¹à¸¢à¸à¸ˆà¸²à¸ search cache)
     
  â‘£ à¹€à¸¡à¸·à¹ˆà¸­ user à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡à¸•à¹ˆà¸­:
     - PromptBuilder check prefetch cache à¸à¹ˆà¸­à¸™
     - Cache hit â†’ Oracle query à¹€à¸£à¹‡à¸§à¸‚à¸¶à¹‰à¸™ 80%+ (skip FTS5+ChromaDB)
     - Cache miss â†’ query à¸›à¸à¸•à¸´
  
  Prefetch Trigger Conditions:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Condition                   â”‚  Prefetch Target              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  à¸„à¸¸à¸¢à¹€à¸£à¸·à¹ˆà¸­à¸‡ X                 â”‚  related concepts à¸‚à¸­à¸‡ X       â”‚
  â”‚  agent à¹ƒà¸Šà¹‰ tool               â”‚  tool documentation           â”‚
  â”‚  user à¸ªà¹ˆà¸‡ code                â”‚  project-specific knowledge   â”‚
  â”‚  à¹€à¸§à¸¥à¸² 09:00 à¸§à¸±à¸™à¸ˆà¸±à¸™à¸—à¸£à¹Œ        â”‚  weekly summary + tasks       â”‚
  â”‚  conversation > 10 turns     â”‚  user model + preferences     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part B â€” Streaming & Response UX (Pillar 4)

> **à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢:** User à¹€à¸«à¹‡à¸™ response à¸—à¸±à¸™à¸—à¸µà¹à¸—à¸™à¸—à¸µà¹ˆà¸ˆà¸°à¸£à¸­ 10-30 à¸§à¸´à¸™à¸²à¸—à¸µ  
> **à¹à¸à¹‰à¸›à¸±à¸à¸«à¸²:** UX à¹à¸¢à¹ˆà¸ˆà¸²à¸à¸à¸²à¸£ "à¸£à¸­" à¸™à¸²à¸™à¹€à¸à¸´à¸™à¹„à¸›  
> **à¸—à¸µà¹ˆà¸—à¸³:** NanoClaw (container-runner.ts, channels), Oracle (optional)  
> **Effort:** Large (~4-5 à¸§à¸±à¸™)

### B.1 â€” Block Streaming Architecture

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** Container à¸—à¸³à¸‡à¸²à¸™à¸ˆà¸™à¹€à¸ªà¸£à¹‡à¸ˆ â†’ NanoClaw à¸£à¸­ output à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” â†’ à¸ªà¹ˆà¸‡à¹ƒà¸«à¹‰ user à¸—à¸µà¹€à¸”à¸µà¸¢à¸§  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** Container stream output à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸—à¸³à¸‡à¸²à¸™ â†’ NanoClaw à¸ªà¹ˆà¸‡à¹ƒà¸«à¹‰ user à¹€à¸›à¹‡à¸™à¸à¹‰à¸­à¸™ à¹†

```
Streaming Pipeline Overview:

  Container Agent (Claude Code SDK)
       â”‚ 
       â”‚ writes stdout incrementally
       â”‚ (with sentinel markers for chunk boundaries)
       â”‚
       â–¼
  NanoClaw Stdout Parser
       â”‚
       â”‚ â‘  detect NANOCLAW_CHUNK markers
       â”‚ â‘¡ buffer characters until chunk complete
       â”‚ â‘¢ emit 'chunk' event via MessageBus
       â”‚
       â–¼
  Block Chunker
       â”‚
       â”‚ â‘£ accumulate chars between chunk markers
       â”‚ â‘¤ split at natural break points (paragraph, bullet, code block)
       â”‚ â‘¥ enforce: minChars=100, maxChars=2000
       â”‚
       â–¼
  Channel Sender
       â”‚
       â”œâ”€â”€ Telegram: editMessageText() â†’ progressive update
       â”œâ”€â”€ WhatsApp: typing indicator â†’ final send
       â””â”€â”€ Future channels: same interface
```

### B.2 â€” Container Streaming Protocol

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ Sentinel Protocol:**

```
à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ (batch):
  ---NANOCLAW_OUTPUT_START---
  (entire response)
  ---NANOCLAW_OUTPUT_END---

à¹ƒà¸«à¸¡à¹ˆ (streaming):
  ---NANOCLAW_OUTPUT_START---
  (chunk 1: first paragraph)
  ---NANOCLAW_CHUNK---
  (chunk 2: code block)
  ---NANOCLAW_CHUNK---
  (chunk 3: explanation)
  ---NANOCLAW_OUTPUT_END---
```

**Container Agent à¸•à¹‰à¸­à¸‡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™:**

```
container/agent-runner/ modifications:

  â‘  Agent runner script (bash/SDK wrapper):
     - à¹€à¸”à¸´à¸¡: capture all output â†’ echo at the end
     - à¹ƒà¸«à¸¡à¹ˆ: stream output à¸—à¸¸à¸ ~500 chars à¸«à¸£à¸·à¸­ natural break
     - break points: paragraph end (\n\n), code block end (```), 
       bullet list end, heading change
  
  â‘¡ Chunk insertion logic:
     function emitChunk(text: string) {
       process.stdout.write(text);
       process.stdout.write('\n---NANOCLAW_CHUNK---\n');
     }
  
  â‘¢ Backward compatibility:
     - à¸–à¹‰à¸² STREAMING=false (env var) â†’ à¹ƒà¸Šà¹‰ batch mode à¹€à¸”à¸´à¸¡
     - à¸•à¸£à¸§à¸ˆ: à¸–à¹‰à¸² output à¹„à¸¡à¹ˆà¸¡à¸µ NANOCLAW_CHUNK â†’ treat as batch
```

### B.3 â€” NanoClaw Chunk Parser

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** `container-runner.ts` à¸­à¹ˆà¸²à¸™ stdout à¸”à¹‰à¸§à¸¢ `child.stdout.on('data')` à¹à¸¥à¹‰à¸§à¸£à¸§à¸¡à¹ƒà¸™ buffer  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** Parse chunk markers à¹à¸šà¸š real-time

```
Chunk Parser State Machine:

  States:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    OUTPUT_START    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  IDLE   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ READING  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                     â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                      CHUNK â”‚                  â”‚ OUTPUT_END
                            â–¼                  â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ EMIT_CHUNK   â”‚     â”‚  DONE    â”‚
                   â”‚ â†’ callback() â”‚     â”‚ â†’ final  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ READING  â”‚ (loop back)
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Parser API:
  
  class ChunkParser extends EventEmitter {
    // events: 'chunk', 'complete', 'error'
    
    feed(data: Buffer): void      // feed raw stdout data
    getFullOutput(): string       // get concatenated output
    isStreaming(): boolean         // true if OUTPUT_START seen
    chunkCount(): number          // number of chunks emitted
  }

  Usage in container-runner.ts:
  
  const parser = new ChunkParser();
  
  parser.on('chunk', (text: string, index: number) => {
    messageBus.emit('stream:chunk', { 
      requestId, groupId, text, index, 
      isFirst: index === 0 
    });
  });
  
  parser.on('complete', (fullText: string) => {
    messageBus.emit('stream:complete', { requestId, fullText });
  });
  
  child.stdout.on('data', (data) => parser.feed(data));
```

### B.4 â€” Telegram Streaming (editMessageText)

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** Telegram à¸ªà¹ˆà¸‡ 1 message à¸•à¸­à¸™à¸ˆà¸š  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** Progressive update â€” user à¹€à¸«à¹‡à¸™ text à¹€à¸à¸´à¹ˆà¸¡à¸‚à¸¶à¹‰à¸™à¹€à¸£à¸·à¹ˆà¸­à¸¢ à¹†

```
Telegram Stream Modes (configurable per group):

  Mode 1: "partial" (recommended)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â‘  à¹€à¸¡à¸·à¹ˆà¸­ first chunk à¸¡à¸²à¸–à¸¶à¸‡:
     - sendMessage(chunk1) â†’ get messageId
     - set typing indicator
     
  â‘¡ à¹€à¸¡à¸·à¹ˆà¸­ chunk N à¸¡à¸²à¸–à¸¶à¸‡ (N > 1):
     - editMessageText(messageId, chunk1 + chunk2 + ... + chunkN)
     - throttle: à¸­à¸¢à¹ˆà¸² edit à¸šà¹ˆà¸­à¸¢à¸à¸§à¹ˆà¸² 1 à¸„à¸£à¸±à¹‰à¸‡/à¸§à¸´à¸™à¸²à¸—à¸µ (Telegram rate limit)
     
  â‘¢ à¹€à¸¡à¸·à¹ˆà¸­ complete:
     - editMessageText(messageId, fullText) â†’ final version
     - remove typing indicator
  
  Rate Limit Protection:
  - Telegram API limit: ~30 edits/second per chat
  - Our throttle: 1 edit/second â†’ safe
  - à¸–à¹‰à¸² edit fail (429) â†’ skip edit, wait for next chunk


  Mode 2: "block" (alternative)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â‘  à¹à¸•à¹ˆà¸¥à¸° chunk â†’ sendMessage() à¹à¸¢à¸à¸à¸±à¸™
  â‘¡ delay à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ blocks: 800-2500ms (human-like pacing)
  â‘¢ first block: à¸ªà¹ˆà¸‡à¸—à¸±à¸™à¸—à¸µ (no delay)
  â‘£ final block: à¸ªà¹ˆà¸‡à¸—à¸±à¸™à¸—à¸µ (no delay)
  
  
  Mode 3: "off" (à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  à¸£à¸­à¸ˆà¸™à¹€à¸ªà¸£à¹‡à¸ˆ â†’ à¸ªà¹ˆà¸‡à¸—à¸µà¹€à¸”à¸µà¸¢à¸§


  Config:
  // groups/<group>/config.json
  {
    "telegram": {
      "streamMode": "partial",     // "partial" | "block" | "off"
      "blockDelay": [800, 2500],   // min/max ms between blocks
      "editThrottleMs": 1000       // min ms between edits
    }
  }
```

### B.5 â€” WhatsApp Streaming

**à¸‚à¹‰à¸­à¸ˆà¸³à¸à¸±à¸”:** WhatsApp API à¹„à¸¡à¹ˆ support editMessage â†’ à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰ strategy à¸•à¹ˆà¸²à¸‡

```
WhatsApp Stream Strategy:

  â‘  typing indicator à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡:
     - sendPresenceUpdate('composing') à¸—à¸¸à¸ 5 à¸§à¸´à¸™à¸²à¸—à¸µà¸ˆà¸™à¸à¸§à¹ˆà¸²à¸ˆà¸°à¹€à¸ªà¸£à¹‡à¸ˆ
     - user à¹€à¸«à¹‡à¸™ "typing..." à¸•à¸¥à¸­à¸” â†’ à¸£à¸¹à¹‰à¸§à¹ˆà¸²à¸¢à¸±à¸‡à¸—à¸³à¸­à¸¢à¸¹à¹ˆ
     
  â‘¡ à¸ªà¸³à¸«à¸£à¸±à¸š response à¸¢à¸²à¸§à¸¡à¸²à¸ (> 4,000 chars):
     - à¹à¸šà¹ˆà¸‡à¹€à¸›à¹‡à¸™ 2-3 messages à¸•à¸²à¸¡ natural breaks
     - delay 500ms à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ messages
     
  â‘¢ à¸ªà¸³à¸«à¸£à¸±à¸š response à¸ªà¸±à¹‰à¸™ (< 4,000 chars):
     - à¸£à¸­à¸ˆà¸™à¹€à¸ªà¸£à¹‡à¸ˆ â†’ à¸ªà¹ˆà¸‡à¸—à¸µà¹€à¸”à¸µà¸¢à¸§ (à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™)
     - typing indicator à¸—à¸³à¹ƒà¸«à¹‰ UX à¸”à¸µà¸‚à¸¶à¹‰à¸™à¹à¸¡à¹‰à¹„à¸¡à¹ˆ stream
```

### B.6 â€” Status Indicators

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** User à¹€à¸«à¹‡à¸™à¹à¸„à¹ˆ "typing..." â†’ à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸§à¹ˆà¸² AI à¸à¸³à¸¥à¸±à¸‡à¸—à¸³à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¹„à¸«à¸™  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** Progressive status à¸—à¸µà¹ˆà¸šà¸­à¸à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™

```
Status Indicator System:

  Status Flow:
  
  ğŸ“¥ "à¹„à¸”à¹‰à¸£à¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸¥à¹‰à¸§"                (à¸—à¸±à¸™à¸—à¸µ â€” < 100ms)
       â†“  (visible only if next step > 2s)
  ğŸ” "à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡..."   (Oracle query phase)
       â†“
  ğŸ§  "à¸à¸³à¸¥à¸±à¸‡à¸„à¸´à¸”..."                      (LLM processing)
       â†“
  âœï¸ "à¸à¸³à¸¥à¸±à¸‡à¹€à¸‚à¸µà¸¢à¸™à¸„à¸³à¸•à¸­à¸š..."               (streaming response)
       â†“
  âœ… [à¸ªà¹ˆà¸‡à¸„à¸³à¸•à¸­à¸šà¸ˆà¸£à¸´à¸‡]                      (final response)

  
  Implementation:
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  NanoClaw Status Manager                           â”‚
  â”‚                                                    â”‚
  â”‚  class StatusManager {                             â”‚
  â”‚    private statusMsgId: number | null              â”‚
  â”‚    private currentPhase: Phase                     â”‚
  â”‚    private startedAt: number                       â”‚
  â”‚                                                    â”‚
  â”‚    setPhase(phase: Phase): void                    â”‚
  â”‚    // à¸–à¹‰à¸² phase change â†’ editMessage status        â”‚
  â”‚    // à¸–à¹‰à¸² phase duration < 2s â†’ skip (à¹„à¸¡à¹ˆ flicker) â”‚
  â”‚                                                    â”‚
  â”‚    cleanup(): void                                 â”‚
  â”‚    // à¸¥à¸š status message à¹€à¸¡à¸·à¹ˆà¸­à¸ªà¹ˆà¸‡à¸„à¸³à¸•à¸­à¸šà¸ˆà¸£à¸´à¸‡           â”‚
  â”‚  }                                                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Phases:
  enum Phase {
    RECEIVED = 'received',
    SEARCHING = 'searching',
    THINKING = 'thinking',
    WRITING = 'writing',
    DONE = 'done'
  }
  
  Rules:
  - à¹à¸ªà¸”à¸‡ status à¸à¹‡à¸•à¹ˆà¸­à¹€à¸¡à¸·à¹ˆà¸­ step à¹ƒà¸Šà¹‰à¹€à¸§à¸¥à¸² > 2 à¸§à¸´à¸™à¸²à¸—à¸µ
  - à¸ªà¸³à¸«à¸£à¸±à¸š inline tier: à¹„à¸¡à¹ˆà¹à¸ªà¸”à¸‡ status (à¸•à¸­à¸šà¸—à¸±à¸™à¸—à¸µ)
  - à¸ªà¸³à¸«à¸£à¸±à¸š oracle-only tier: à¹à¸ªà¸”à¸‡ SEARCHING â†’ DONE
  - à¸ªà¸³à¸«à¸£à¸±à¸š container-* tier: à¹à¸ªà¸”à¸‡ SEARCHING â†’ THINKING â†’ WRITING â†’ DONE
  - Telegram: sendMessage (status) â†’ editMessage â†’ deleteMessage + sendMessage (answer)  
  - WhatsApp: sendPresenceUpdate('composing') + reaction emoji à¸–à¹‰à¸²à¸£à¸­à¸‡à¸£à¸±à¸š
```

---

## Part C â€” Cost Intelligence (Pillar 3)

> **à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢:** à¸„à¸§à¸šà¸„à¸¸à¸¡à¸„à¹ˆà¸²à¹ƒà¸Šà¹‰à¸ˆà¹ˆà¸²à¸¢ LLM à¹à¸šà¸š proactive à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰ overshoot  
> **à¹à¸à¹‰à¸›à¸±à¸à¸«à¸²:** à¹„à¸¡à¹ˆà¸¡à¸µ budget limit, model pricing hardcoded, à¹„à¸¡à¹ˆà¸¡à¸µ alerting  
> **à¸—à¸µà¹ˆà¸—à¸³:** NanoClaw (cost-tracker.ts â†’ cost-intelligence.ts)  
> **Effort:** Medium (~2-3 à¸§à¸±à¸™)

### C.1 â€” Enhanced Cost Tracker

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ (cost-tracker.ts):**
- à¹€à¸à¹‡à¸š `usage_tracking` table: tier, model, response_time, input/output tokens, cost, userId
- `getCostSummary()` â†’ today + thisMonth totals
- Model pricing: hardcoded Haiku/Sonnet/Opus
- **à¹„à¸¡à¹ˆà¸¡à¸µ:** budget, alerts, per-group tracking, trend analysis

**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:**

```
Enhanced Cost Tracker (cost-intelligence.ts):

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Data Model                                                â”‚
  â”‚                                                            â”‚
  â”‚  Table: usage_tracking (à¹€à¸”à¸´à¸¡ â€” à¹€à¸à¸´à¹ˆà¸¡ columns):             â”‚
  â”‚    + group_id TEXT                                         â”‚
  â”‚    + trace_id TEXT (link to request trace)                 â”‚
  â”‚    + cache_hit BOOLEAN (à¸–à¹‰à¸² Oracle cache hit â†’ cost = 0)   â”‚
  â”‚                                                            â”‚
  â”‚  Table: cost_budgets (à¹ƒà¸«à¸¡à¹ˆ):                               â”‚
  â”‚    group_id TEXT PRIMARY KEY                               â”‚
  â”‚    monthly_budget REAL          -- $/month limit           â”‚
  â”‚    daily_budget REAL            -- $/day limit (optional)  â”‚
  â”‚    alert_threshold REAL         -- % à¸—à¸µà¹ˆà¸ˆà¸° alert (0.8)     â”‚
  â”‚    downgrade_threshold REAL     -- % à¸—à¸µà¹ˆà¸ˆà¸° auto-downgrade  â”‚
  â”‚    hard_limit_threshold REAL    -- % à¸—à¸µà¹ˆà¸ˆà¸° stop            â”‚
  â”‚    preferred_model TEXT         -- model à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸›à¸à¸•à¸´         â”‚
  â”‚    downgrade_model TEXT         -- model à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹€à¸¡à¸·à¹ˆà¸­ budget â”‚
  â”‚    created_at INTEGER                                      â”‚
  â”‚    updated_at INTEGER                                      â”‚
  â”‚                                                            â”‚
  â”‚  Table: cost_alerts (à¹ƒà¸«à¸¡à¹ˆ):                                â”‚
  â”‚    id INTEGER PRIMARY KEY AUTOINCREMENT                    â”‚
  â”‚    group_id TEXT                                           â”‚
  â”‚    alert_type TEXT              -- 'budget_warn' | 'budget_â”‚
  â”‚                                    downgrade' | 'budget_   â”‚
  â”‚                                    exceeded'               â”‚
  â”‚    threshold_pct REAL                                      â”‚
  â”‚    current_spend REAL                                      â”‚
  â”‚    budget_limit REAL                                       â”‚
  â”‚    action_taken TEXT                                        â”‚
  â”‚    created_at INTEGER                                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### C.2 â€” Budget Enforcement

```
Budget Enforcement Engine:

  à¸à¹ˆà¸­à¸™à¸—à¸¸à¸ LLM request:
  
  â‘  à¸„à¸³à¸™à¸§à¸“ current spend (today + this month):
     - query usage_tracking WHERE month = current
     - cache result 5 minutes (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡ query à¸—à¸¸à¸ request)
  
  â‘¡ à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸š budget:
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Spend Level         â”‚  Action                            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  < 80% budget        â”‚  âœ… Normal â€” à¹ƒà¸Šà¹‰ preferred model   â”‚
  â”‚                      â”‚                                    â”‚
  â”‚  80-95% budget       â”‚  âš ï¸ Alert via Telegram             â”‚
  â”‚                      â”‚  "Budget 85% used ($17/$20)"       â”‚
  â”‚                      â”‚  à¸¢à¸±à¸‡à¹ƒà¸Šà¹‰ preferred model             â”‚
  â”‚                      â”‚                                    â”‚
  â”‚  95-100% budget      â”‚  ğŸ”¶ Auto-downgrade model           â”‚
  â”‚                      â”‚  Sonnet â†’ Haiku                    â”‚
  â”‚                      â”‚  Alert: "Downgraded to save cost"  â”‚
  â”‚                      â”‚                                    â”‚
  â”‚  100-120% budget     â”‚  ğŸ”´ Haiku-only mode                â”‚
  â”‚                      â”‚  à¸—à¸¸à¸ request à¹ƒà¸Šà¹‰ Haiku              â”‚
  â”‚                      â”‚  Alert: "Budget exceeded"          â”‚
  â”‚                      â”‚                                    â”‚
  â”‚  > 120% budget       â”‚  â›” Offline mode                   â”‚
  â”‚                      â”‚  à¸•à¸­à¸š inline only (template)        â”‚
  â”‚                      â”‚  "à¸‚à¸­à¹‚à¸—à¸© budget à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰à¸«à¸¡à¸”à¹à¸¥à¹‰à¸§"    â”‚
  â”‚                      â”‚  Alert: "HARD LIMIT â€” service off" â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  Auto-reset:
  - Monthly budget resets à¸§à¸±à¸™à¸—à¸µà¹ˆ 1 à¸‚à¸­à¸‡à¹€à¸”à¸·à¸­à¸™ 00:00 UTC+7
  - Daily budget resets 00:00 UTC+7 à¸—à¸¸à¸à¸§à¸±à¸™
  - Alerts re-arm à¹€à¸¡à¸·à¹ˆà¸­ spend à¸¥à¸”à¸¥à¸‡à¸•à¹ˆà¸³à¸à¸§à¹ˆà¸² threshold (à¹€à¸Šà¹ˆà¸™ month reset)
```

### C.3 â€” Dynamic Model Pricing

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** Hardcoded 3 models à¹ƒà¸™ cost-tracker.ts  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** Configurable pricing + support Z.AI GLM models

```
Model Pricing Config:

  // config/model-pricing.json (or env-based)
  {
    "models": {
      "claude-sonnet-4": {
        "inputPer1M": 3.00,
        "outputPer1M": 15.00,
        "contextWindow": 200000
      },
      "claude-haiku-3.5": {
        "inputPer1M": 0.25,
        "outputPer1M": 1.25,
        "contextWindow": 200000
      },
      "glm-4.7": {
        "inputPer1M": 0.50,
        "outputPer1M": 2.00,
        "contextWindow": 128000
      },
      "glm-4.5-air": {
        "inputPer1M": 0.10,
        "outputPer1M": 0.50,
        "contextWindow": 128000
      }
    },
    "defaultModel": "claude-sonnet-4",
    "downgradeModel": "claude-haiku-3.5"
  }
```

### C.4 â€” Cost Chat Commands

```
User-facing Commands:

  /usage â†’ à¸£à¸²à¸¢à¸‡à¸²à¸™à¸„à¹ˆà¸²à¹ƒà¸Šà¹‰à¸ˆà¹ˆà¸²à¸¢à¸§à¸±à¸™à¸™à¸µà¹‰
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ğŸ“Š à¸ªà¸£à¸¸à¸›à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸§à¸±à¸™à¸™à¸µà¹‰:
  
  Requests: 45 (inline: 20, oracle: 12, container: 13)
  Cost: $1.23 (Sonnet: $1.10, Haiku: $0.13)
  Budget: $20/month â€” à¹ƒà¸Šà¹‰à¹„à¸› 62% ($12.40)
  Projected: $19.80/month (within budget âœ…)
  
  Top costs:
  1. Docker deployment question â€” $0.42 (Sonnet, 3 tool calls)
  2. Code review request â€” $0.31 (Sonnet, 2 tool calls)
  3. Memory system debug â€” $0.18 (Sonnet, 1 tool call)


  /cost â†’ à¸ªà¸£à¸¸à¸›à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰ + trend
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ğŸ’° Cost Summary â€” February 2026:
  
  Week 1: $4.20 (avg $0.60/day)
  Week 2: $5.10 (avg $0.73/day) â†‘22%
  Week 3 (current): $3.10 (avg $0.78/day) â†‘7%
  
  Total: $12.40 / $20.00 budget (62%)
  
  By Model:
  - Sonnet: $10.20 (82%)
  - Haiku: $2.00 (16%)
  - Inline: $0.20 (2%)
  
  By Group:
  - main: $11.00 (89%)
  - global: $1.40 (11%)


  /budget [amount] â†’ à¸•à¸±à¹‰à¸‡ budget
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  /budget 30 â†’ "Budget à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰à¸•à¸±à¹‰à¸‡à¹€à¸›à¹‡à¸™ $30.00 à¹à¸¥à¹‰à¸§ âœ…"
  /budget â†’ "Budget à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™: $20.00/month (à¹ƒà¸Šà¹‰à¹„à¸› 62%)"
```

### C.5 â€” Smart Cost Reduction

```
Automatic Cost Optimization:

  â‘  Conversation Complexity Downgrade:
     - à¸–à¹‰à¸² 3 messages à¸•à¸´à¸”à¸à¸±à¸™à¹€à¸›à¹‡à¸™à¸„à¸³à¸–à¸²à¸¡à¸ªà¸±à¹‰à¸™ (< 50 chars) + à¹„à¸¡à¹ˆà¸¡à¸µ tool call
     â†’ auto-switch à¸ˆà¸²à¸ Sonnet â†’ Haiku
     - reset à¹€à¸¡à¸·à¹ˆà¸­: user à¸ªà¹ˆà¸‡ code, à¸–à¸²à¸¡à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™, à¸‚à¸­ analysis
  
  â‘¡ Aggressive Oracle Caching:
     - à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™: search cache TTL = 5 à¸™à¸²à¸—à¸µ
     - à¹€à¸à¸´à¹ˆà¸¡: à¸–à¹‰à¸² budget > 80% â†’ extend cache TTL à¹€à¸›à¹‡à¸™ 15 à¸™à¸²à¸—à¸µ
     - à¸–à¹‰à¸² budget > 95% â†’ extend à¹€à¸›à¹‡à¸™ 30 à¸™à¸²à¸—à¸µ
     
  â‘¢ Token Estimation Warning:
     - à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸‡ large context â†’ estimate cost
     - à¸–à¹‰à¸² estimated cost > $0.50/request â†’ log warning
     - à¸–à¹‰à¸² > $1.00/request â†’ require confirmation (Telegram only)
```

---

## Part D â€” Observability (Pillar 7)

> **à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢:** à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸§à¹ˆà¸²à¸£à¸°à¸šà¸šà¸—à¸³à¸­à¸°à¹„à¸£à¸­à¸¢à¸¹à¹ˆ à¸•à¸£à¸‡à¹„à¸«à¸™à¸Šà¹‰à¸² à¸•à¸£à¸‡à¹„à¸«à¸™à¸à¸±à¸‡  
> **à¹à¸à¹‰à¸›à¸±à¸à¸«à¸²:** Debug à¸¢à¸²à¸, à¹„à¸¡à¹ˆà¸¡à¸µ tracing, à¹„à¸¡à¹ˆà¸¡à¸µ health dashboard  
> **à¸—à¸µà¹ˆà¸—à¸³:** à¸—à¸±à¹‰à¸‡ NanoClaw + Oracle  
> **Effort:** Large (~3-4 à¸§à¸±à¸™)

### D.1 â€” Request Tracing

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** à¹„à¸¡à¹ˆà¸¡à¸µ trace ID â€” à¹€à¸¡à¸·à¹ˆà¸­ response à¸Šà¹‰à¸² à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸§à¹ˆà¸² bottleneck à¸­à¸¢à¸¹à¹ˆà¸•à¸£à¸‡à¹„à¸«à¸™  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** Unique trace ID per message, à¸šà¸±à¸™à¸—à¸¶à¸ timeline à¸—à¸¸à¸à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™

```
Trace Architecture:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Trace Record                                               â”‚
  â”‚                                                             â”‚
  â”‚  {                                                          â”‚
  â”‚    traceId: "tr_a1b2c3d4",                                  â”‚
  â”‚    groupId: "main",                                         â”‚
  â”‚    userId: "user123",                                       â”‚
  â”‚    channel: "telegram",                                     â”‚
  â”‚    tier: "container-light",                                 â”‚
  â”‚    model: "haiku",                                          â”‚
  â”‚    startedAt: 1771249945874,                                â”‚
  â”‚    completedAt: 1771249948200,                              â”‚
  â”‚    totalMs: 2326,                                           â”‚
  â”‚    inputTokens: 1200,                                       â”‚
  â”‚    outputTokens: 340,                                       â”‚
  â”‚    costUsd: 0.001,                                          â”‚
  â”‚    cacheHit: false,                                         â”‚
  â”‚    error: null,                                             â”‚
  â”‚    spans: [                                                 â”‚
  â”‚      { name: "received",     startMs: 0,     durationMs: 2 },    â”‚
  â”‚      { name: "classify",     startMs: 2,     durationMs: 3 },    â”‚
  â”‚      { name: "oracle_ctx",   startMs: 5,     durationMs: 115 },  â”‚
  â”‚      { name: "queue_wait",   startMs: 120,   durationMs: 15 },   â”‚
  â”‚      { name: "container",    startMs: 135,   durationMs: 1850 }, â”‚
  â”‚      { name: "channel_send", startMs: 1985,  durationMs: 120 },  â”‚
  â”‚    ]                                                        â”‚
  â”‚  }                                                          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Storage:
  
  Table: request_traces
    trace_id TEXT PRIMARY KEY
    group_id TEXT
    user_id TEXT
    channel TEXT           -- 'telegram' | 'whatsapp'
    tier TEXT              -- 'inline' | 'oracle-only' | 'container-light' | 'container-full'
    model TEXT
    started_at INTEGER
    completed_at INTEGER
    total_ms INTEGER
    input_tokens INTEGER
    output_tokens INTEGER
    cost_usd REAL
    cache_hit BOOLEAN
    error TEXT
    spans TEXT             -- JSON array of spans
    
  Indexes:
    CREATE INDEX idx_traces_group ON request_traces(group_id, started_at)
    CREATE INDEX idx_traces_slow ON request_traces(total_ms) WHERE total_ms > 10000
    
  Retention:
    - Keep: 7 days full detail
    - Archive: 30 days summary only (no spans)
    - Delete: > 30 days
```

**Trace Implementation:**

```
class RequestTracer {
  private traceId: string;
  private spans: Span[] = [];
  private activeSpan: Span | null = null;

  constructor(groupId: string, userId: string, channel: string) {
    this.traceId = `tr_${randomId(8)}`;
  }

  startSpan(name: string): void {
    // end previous if any
    if (this.activeSpan) this.endSpan();
    this.activeSpan = { name, startMs: elapsed(), durationMs: 0 };
  }

  endSpan(): void {
    if (!this.activeSpan) return;
    this.activeSpan.durationMs = elapsed() - this.activeSpan.startMs;
    this.spans.push(this.activeSpan);
    this.activeSpan = null;
  }

  finish(): TraceRecord {
    this.endSpan();
    return { traceId: this.traceId, spans: this.spans, totalMs: elapsed(), ... };
  }

  // Pass trace ID to Oracle via header: X-Trace-Id
  getTraceHeader(): Record<string, string> {
    return { 'X-Trace-Id': this.traceId };
  }
}

// Usage in NanoClaw message pipeline:
const tracer = new RequestTracer(groupId, userId, 'telegram');
tracer.startSpan('received');
// ... classify
tracer.startSpan('classify');
const { tier, model } = classifyQuery(message);
tracer.startSpan('oracle_ctx');
// ... fetch Oracle context
tracer.startSpan('container');
// ... run container
tracer.startSpan('channel_send');
// ... send response
const trace = tracer.finish();
storeTrace(trace);
```

### D.2 â€” NanoClaw Health Check

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** NanoClaw **à¹„à¸¡à¹ˆà¸¡à¸µ health check** â†’ Docker restart policy à¹„à¸¡à¹ˆà¸—à¸³à¸‡à¸²à¸™  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** HTTP health endpoint + Docker HEALTHCHECK

```
NanoClaw Health Endpoint:

  GET /health â†’ 200 OK
  {
    "status": "healthy",
    "uptime": 86400,
    "version": "1.1.0",
    "channels": {
      "telegram": { "connected": true, "lastMessage": 1771249945874 },
      "whatsapp": { "connected": true, "lastMessage": 1771249940000 }
    },
    "containers": {
      "poolSize": 2,
      "active": 1,
      "maxConcurrent": 4
    },
    "queue": {
      "pending": 0,
      "processing": 1
    },
    "oracle": {
      "reachable": true,
      "lastCheckMs": 45
    },
    "resources": {
      "cpuUsage": 0.35,
      "memoryFree": 0.65,
      "diskFree": 0.82
    },
    "cost": {
      "todayUsd": 1.23,
      "monthUsd": 12.40,
      "budgetPct": 0.62
    }
  }

  Implementation:
  - Hono.js HTTP server on port 47780 (internal only)
  - OR: express-minimal / built-in Node HTTP server (à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡ Hono dependency)
  - Docker HEALTHCHECK: curl -f http://localhost:47780/health || exit 1
  - interval: 30s, timeout: 10s, retries: 3
```

**docker-compose.yml update:**

```yaml
nanoclaw:
  # ... existing config
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:47780/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 20s
```

### D.3 â€” Structured Logging

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** Pino logger â†’ console only, à¹„à¸¡à¹ˆà¸¡à¸µ trace ID, à¹„à¸¡à¹ˆà¸¡à¸µ correlation  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** Structured JSON logs with trace ID + file transport

```
Logging Enhancement:

  â‘  Trace ID in every log line:
     - pino child logger per request: logger.child({ traceId })
     - à¸—à¸¸à¸ log message à¸ à¸²à¸¢à¹ƒà¸™ request lifecycle à¸ˆà¸°à¸¡à¸µ traceId
     
  â‘¡ Log levels standardization:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Level  â”‚  Usage                                             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  fatal  â”‚  Process crash, unrecoverable error                â”‚
  â”‚  error  â”‚  Request failed, tool error, container crash       â”‚
  â”‚  warn   â”‚  Budget threshold, slow query > 10s, rate limit    â”‚
  â”‚  info   â”‚  Request lifecycle events, important state changes â”‚
  â”‚  debug  â”‚  Oracle query details, container stdout, cache ops â”‚
  â”‚  trace  â”‚  Every function entry/exit (dev only)              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  â‘¢ File transport:
     - logs/<date>.jsonl â†’ rotated daily
     - keep 7 days â†’ auto-delete older
     - format: JSONL (one JSON object per line)
     
  â‘£ Oracle logs:
     - Oracle Hono server: add pino middleware
     - Accept X-Trace-Id header â†’ include in Oracle logs
     - Correlate NanoClaw + Oracle logs by traceId
```

### D.4 â€” /doctor Command (Self-Diagnosis)

```
Self-Diagnosis System:

  /doctor â†’ à¸•à¸£à¸§à¸ˆà¸ªà¸¸à¸‚à¸ à¸²à¸à¸£à¸°à¸šà¸šà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  ğŸ¥ JellyCore Health Report
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  Services:
  âœ… Oracle V2          47778  (response: 45ms)
  âœ… ChromaDB           8000   (response: 12ms)  
  âœ… Thai NLP Sidecar   8080   (response: 23ms)
  âœ… NanoClaw           47780  (uptime: 3d 12h)
  
  Channels:
  âœ… Telegram    connected (last msg: 2m ago)
  âœ… WhatsApp    connected (last msg: 15m ago)
  
  Memory:
  âœ… Oracle DB    5,523 documents (42 MB)
  âœ… ChromaDB     5,200 vectors (128 MB)
  âš ï¸ Decay Score  3 docs with score < 10
  âœ… User Models  2 active
  âœ… Procedures   8 stored
  âœ… Episodes     12 active (3 expired)
  
  Performance (last 24h):
  âœ… Avg response: 3.2s (target: <10s)
  âœ… P95 response: 8.1s (target: <15s)
  âš ï¸ Slow queries: 2 (>10s)
  âœ… Cache hit rate: 34%
  
  Cost:
  âœ… Today: $1.23 / $5.00 daily limit
  âœ… Month: $12.40 / $20.00 budget (62%)
  
  Disk:
  âœ… Data volume: 42% used (8.4 GB / 20 GB)
  âœ… Logs: 120 MB (7 days retained)
  
  Issues Found: 1
  âš ï¸ 3 documents have decay_score < 10 â€” consider archiving
     Run: oracle_search with type=stale to review
  
  
  Implementation:
  
  class DoctorService {
    async runDiagnostics(): Promise<DiagnosticReport> {
      const checks = await Promise.allSettled([
        this.checkOracle(),
        this.checkChromaDB(),
        this.checkThaiNLP(),
        this.checkChannels(),
        this.checkMemory(),
        this.checkPerformance(),
        this.checkCost(),
        this.checkDisk(),
      ]);
      return this.formatReport(checks);
    }
  }
```

### D.5 â€” Knowledge Quality Metrics

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸´à¸˜à¸µà¸§à¸±à¸”à¸„à¸¸à¸“à¸ à¸²à¸à¸à¸²à¸™à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** à¸§à¸±à¸” + à¹à¸ªà¸”à¸‡ quality metrics

```
Knowledge Quality Dashboard:

  Metrics (computed daily â€” background job):
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Metric               â”‚  à¸„à¸³à¸™à¸§à¸“                â”‚  Target       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Health Score         â”‚  weighted average of  â”‚  > 80%        â”‚
  â”‚                       â”‚  all metrics below    â”‚               â”‚
  â”‚                       â”‚                       â”‚               â”‚
  â”‚  Freshness            â”‚  % docs with decay    â”‚  > 70%        â”‚
  â”‚                       â”‚  score > 50           â”‚               â”‚
  â”‚                       â”‚                       â”‚               â”‚
  â”‚  Coverage             â”‚  unique concepts Ã·    â”‚  > 500        â”‚
  â”‚                       â”‚  total expected topicsâ”‚  concepts     â”‚
  â”‚                       â”‚                       â”‚               â”‚
  â”‚  Contradiction Rate   â”‚  contradictions found â”‚  < 2%         â”‚
  â”‚                       â”‚  Ã· total docs         â”‚               â”‚
  â”‚                       â”‚                       â”‚               â”‚
  â”‚  Duplicate Rate       â”‚  near-duplicates      â”‚  < 5%         â”‚
  â”‚                       â”‚  (similarity > 0.95)  â”‚               â”‚
  â”‚                       â”‚                       â”‚               â”‚
  â”‚  Access Distribution  â”‚  Gini coefficient     â”‚  < 0.7        â”‚
  â”‚                       â”‚  of access_count      â”‚  (not skewed) â”‚
  â”‚                       â”‚                       â”‚               â”‚
  â”‚  Stale Content        â”‚  docs not accessed    â”‚  < 10%        â”‚
  â”‚                       â”‚  in 90 days           â”‚               â”‚
  â”‚                       â”‚                       â”‚               â”‚
  â”‚  Layer Balance        â”‚  % docs per layer     â”‚  semantic>60% â”‚
  â”‚                       â”‚  vs expected ratio    â”‚  proc>10%     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Storage:
  
  Table: knowledge_quality_log (Oracle)
    id INTEGER PRIMARY KEY AUTOINCREMENT
    computed_at INTEGER
    health_score REAL
    freshness REAL
    coverage INTEGER
    contradiction_rate REAL
    duplicate_rate REAL
    access_gini REAL
    stale_pct REAL
    layer_distribution TEXT  -- JSON {semantic: 0.65, procedural: 0.15, ...}
    details TEXT             -- JSON with per-metric breakdown
    
  Background Job:
  - Run daily at 03:00 UTC+7 (low traffic)
  - Takes ~30 seconds for 5,500 docs
  - Results viewable via /doctor or Dashboard
  
  Alert Triggers:
  - Health score < 60% â†’ warn via Telegram
  - Contradiction rate > 5% â†’ warn + list contradictions
  - Stale content > 20% â†’ suggest batch refresh
```

### D.6 â€” Oracle API: /api/traces Endpoint

```
Trace API Endpoints:

  GET /api/traces
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Query params:
    ?limit=20&offset=0           â€” pagination
    ?groupId=main                â€” filter by group  
    ?slow=true                   â€” only traces > 10s
    ?since=2026-02-15T00:00:00Z  â€” time range
    ?traceId=tr_a1b2c3d4         â€” specific trace
    
  Response:
  {
    "traces": [ ... ],
    "total": 1234,
    "offset": 0,
    "limit": 20
  }

  GET /api/traces/:traceId
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Full trace with spans timeline
  
  GET /api/traces/stats
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Aggregate stats:
  {
    "last24h": {
      "totalRequests": 156,
      "avgResponseMs": 3200,
      "p50Ms": 2100,
      "p95Ms": 8100,
      "p99Ms": 12500,
      "errorRate": 0.02,
      "cacheHitRate": 0.34,
      "byTier": { "inline": 45, "oracle-only": 32, "container-light": 55, "container-full": 24 },
      "byModel": { "haiku": 87, "sonnet": 69 }
    }
  }
```

---

## Part E â€” Agent Loop Sophistication (Pillar 5)

> **à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢:** à¸›à¸£à¸±à¸š output pipeline à¹ƒà¸«à¹‰ clean + intelligent  
> **à¹à¸à¹‰à¸›à¸±à¸à¸«à¸²:** Raw agent output à¹„à¸¡à¹ˆà¸›à¸£à¸±à¸šà¸•à¸²à¸¡ channel, tool results à¹ƒà¸«à¸à¹ˆà¹ƒà¸™ context  
> **à¸—à¸µà¹ˆà¸—à¸³:** NanoClaw (container-runner.ts, output pipeline)  
> **Effort:** Medium (~2-3 à¸§à¸±à¸™)  
> **Dependencies:** Part A (compaction), Part B (streaming)

### E.1 â€” Reply Shaping

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** Agent output à¸ªà¹ˆà¸‡à¸•à¸£à¸‡à¸–à¸¶à¸‡ user â†’ format à¸­à¸²à¸ˆà¹„à¸¡à¹ˆà¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸š channel  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** Post-processing pipeline à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸‡

```
Output Processing Pipeline:

  Raw Agent Output
       â”‚
       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Step 1: NO_REPLY Check                             â”‚
  â”‚  à¸–à¹‰à¸² output.trim() === 'NO_REPLY'                   â”‚
  â”‚  â†’ skip sending, log the turn, return early         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Step 2: Sentinel Cleanup                           â”‚
  â”‚  à¸¥à¸š NANOCLAW_* markers à¸—à¸µà¹ˆà¸«à¸¥à¸¸à¸”à¸¡à¸²à¹ƒà¸™ output           â”‚
  â”‚  à¸¥à¸š [Tool result: ...] artifacts                    â”‚
  â”‚  à¸¥à¸š thinking blocks <think>...</think>              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Step 3: Length Enforcement                         â”‚
  â”‚  Telegram: max 4,096 chars per message              â”‚
  â”‚  WhatsApp: max 65,536 chars (but prefer < 4,000)    â”‚
  â”‚  à¸–à¹‰à¸²à¹€à¸à¸´à¸™ â†’ split à¸•à¸²à¸¡ paragraph/heading boundary     â”‚
  â”‚  à¸–à¹‰à¸² split > 5 messages â†’ à¸•à¸±à¸” + "(à¸•à¹ˆà¸­...)"          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Step 4: Markdown Normalization                     â”‚
  â”‚  Telegram: keep Markdown (MarkdownV2 parse mode)    â”‚
  â”‚  WhatsApp: convert Markdown â†’ WhatsApp format:      â”‚
  â”‚    **bold** â†’ *bold*                                â”‚
  â”‚    `code` â†’ ```code```                              â”‚
  â”‚    [link](url) â†’ url                                â”‚
  â”‚    # Heading â†’ *Heading*                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Step 5: Sensitive Data Scrub                       â”‚
  â”‚  à¸¥à¸š API keys à¸—à¸µà¹ˆà¸­à¸²à¸ˆà¸«à¸¥à¸¸à¸”: sk-*, ANTHROPIC_API_KEY=  â”‚
  â”‚  à¸¥à¸š passwords, tokens, secrets                      â”‚
  â”‚  Replace à¸”à¹‰à¸§à¸¢ [REDACTED]                            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
  Channel Send (Telegram / WhatsApp)
```

### E.2 â€” Tool Result Sanitization

**à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:** Tool results à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ context â†’ à¹ƒà¸Šà¹‰ tokens à¸¡à¸²à¸  
**à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:** Sanitize tool results à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸‡à¸à¸¥à¸±à¸šà¹€à¸‚à¹‰à¸² context

```
Tool Result Sanitization Rules:

  à¹€à¸¡à¸·à¹ˆà¸­ container à¸ªà¹ˆà¸‡ tool result à¸à¸¥à¸±à¸š:
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Rule                    â”‚  Action                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Size > 50,000 chars     â”‚  Truncate: head 5,000 + tail     â”‚
  â”‚                          â”‚  5,000 + "[truncated from N]"     â”‚
  â”‚                          â”‚                                   â”‚
  â”‚  Contains base64 image   â”‚  Replace: "[Image: {description}  â”‚
  â”‚                          â”‚  â€” {N} bytes, {format}]"          â”‚
  â”‚                          â”‚                                   â”‚
  â”‚  Contains stack trace    â”‚  Summarize: first line + last 5   â”‚
  â”‚                          â”‚  lines + "[{N} lines omitted]"    â”‚
  â”‚                          â”‚                                   â”‚
  â”‚  Contains API keys/      â”‚  Redact: replace with [REDACTED]  â”‚
  â”‚  secrets/passwords       â”‚  Pattern: sk-*, key=*, password=* â”‚
  â”‚                          â”‚                                   â”‚
  â”‚  Contains binary data    â”‚  Replace: "[Binary data: {N}      â”‚
  â”‚                          â”‚  bytes, type: {mime}]"             â”‚
  â”‚                          â”‚                                   â”‚
  â”‚  Repeated lines (>10x)   â”‚  Deduplicate: show 3 + "[{N}     â”‚
  â”‚                          â”‚  identical lines omitted]"         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Implementation:
  
  class ToolResultSanitizer {
    sanitize(toolName: string, result: string): string {
      let output = result;
      output = this.truncateIfLarge(output);
      output = this.replaceBase64Images(output);
      output = this.summarizeStackTraces(output);
      output = this.redactSecrets(output);
      output = this.replaceBinaryData(output);
      output = this.deduplicateLines(output);
      return output;
    }
  }
```

### E.3 â€” NO_REPLY System

```
NO_REPLY Protocol:

  Use Cases:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Scenario                  â”‚  Agent Response               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Memory flush              â”‚  (writes to Oracle) NO_REPLY  â”‚
  â”‚  Background task complete  â”‚  NO_REPLY                     â”‚
  â”‚  Self-reflection           â”‚  (evaluates quality) NO_REPLY â”‚
  â”‚  Scheduled job result      â”‚  NO_REPLY (log only)          â”‚
  â”‚  Duplicate message         â”‚  NO_REPLY                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  Detection:
  const isNoReply = (output: string) => {
    const trimmed = output.trim();
    return trimmed === 'NO_REPLY' 
        || trimmed === '[NO_REPLY]'
        || trimmed.startsWith('NO_REPLY:');  // allows reason: NO_REPLY:flush_complete
  };
  
  Behavior:
  - à¹„à¸¡à¹ˆà¸ªà¹ˆà¸‡à¸­à¸°à¹„à¸£à¹ƒà¸«à¹‰ user
  - Log: "[no-reply] {traceId} reason={reason}"
  - à¹„à¸¡à¹ˆà¸™à¸±à¸š cost (à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ flush â†’ cost à¸™à¸±à¸šà¹ƒà¸™ flush budget)
  - à¹„à¸¡à¹ˆà¸™à¸±à¸š response time metric
```

---

## Part F â€” Skills & Extensibility (Pillar 6)

> **à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢:** à¹€à¸à¸´à¹ˆà¸¡à¸„à¸§à¸²à¸¡à¸ªà¸²à¸¡à¸²à¸£à¸– agent à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹à¸à¹‰ code  
> **à¹à¸à¹‰à¸›à¸±à¸à¸«à¸²:** à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆà¸ˆà¸°à¹€à¸à¸´à¹ˆà¸¡ feature â†’ à¸•à¹‰à¸­à¸‡à¹à¸à¹‰ source code  
> **à¸—à¸µà¹ˆà¸—à¸³:** NanoClaw (prompt-builder.ts, skill loader)  
> **Effort:** Medium (~2-3 à¸§à¸±à¸™)

### F.1 â€” Standardized Skill Format

```
Skill Structure:

  groups/<group>/skills/<skill-name>/SKILL.md
  
  à¸«à¸£à¸·à¸­
  
  skills/global/<skill-name>/SKILL.md    (à¹ƒà¸Šà¹‰à¸—à¸¸à¸ group)
  
  
  Example: skills/global/web-search/SKILL.md
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ---
  name: web-search
  description: Search the web for current information
  version: 1.0.0
  author: jellycore
  enabled: true
  
  # Prerequisites â€” à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸„à¸£à¸š skill à¸ˆà¸°à¸–à¸¹à¸ skip
  prerequisites:
    env:
      - TAVILY_API_KEY          # à¸•à¹‰à¸­à¸‡à¸¡à¸µ env var à¸™à¸µà¹‰
    bins:
      - curl                    # à¸•à¹‰à¸­à¸‡à¸¡à¸µ binary à¸™à¸µà¹‰à¹ƒà¸™ PATH
    services:
      - oracle                  # à¸•à¹‰à¸­à¸‡à¸¡à¸µ service à¸™à¸µà¹‰ running
  
  # Gating â€” à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¹€à¸›à¸´à¸”à¹ƒà¸Šà¹‰
  gating:
    tiers: [container-light, container-full]   # à¹ƒà¸Šà¹‰à¹ƒà¸™ tier à¹„à¸«à¸™à¸šà¹‰à¸²à¸‡
    groups: ["*"]                               # à¹ƒà¸Šà¹‰à¹ƒà¸™ group à¹„à¸«à¸™ (* = à¸—à¸¸à¸ group)
    maxCostPerCall: 0.01                        # budget guard
  ---
  
  ## Instructions
  
  You have access to web search capabilities. When the user asks about:
  - Current events or news
  - Real-time information (weather, stock, sports)
  - Anything that requires up-to-date data beyond your training
  
  Use the `web_search` tool to find relevant information.
  
  ## Guidelines
  
  1. Always cite sources with URLs
  2. Prefer Thai-language sources if the user communicates in Thai
  3. Synthesize information, don't just copy-paste
  4. If search returns no useful results, say so honestly
  
  ## Available Tools
  
  - `web_search(query: string, maxResults?: number)`: Search and return results
  - `web_read(url: string)`: Read a specific webpage
```

### F.2 â€” Skill Loader

```
Skill Loading Pipeline:

  â‘  Startup: scan skill directories
     - groups/<group>/skills/*/SKILL.md  
     - skills/global/*/SKILL.md
     
  â‘¡ Parse each SKILL.md:
     - Extract YAML frontmatter
     - Validate prerequisites (env vars, binaries, services)
     - Check gating conditions
     - Parse Markdown body as instruction text
     
  â‘¢ Build skill registry:
  
  Map<groupId, Skill[]>
  
  interface Skill {
    name: string;
    description: string;
    version: string;
    enabled: boolean;
    prerequisites: { env: string[]; bins: string[]; services: string[] };
    gating: { tiers: string[]; groups: string[]; maxCostPerCall: number };
    instructions: string;    // Markdown body
    filePath: string;        // for hot-reload watching
    loadedAt: number;
    valid: boolean;          // false if prerequisites not met
    invalidReason?: string;
  }
  
  â‘£ Inject into system prompt:
     - PromptBuilder à¸”à¸¶à¸‡ skills à¸—à¸µà¹ˆ valid + match tier + match group
     - append skill instructions à¸«à¸¥à¸±à¸‡ main system prompt
     - format:
       --- SKILL: web-search ---
       {instructions}
       --- END SKILL ---
  
  â‘¤ Runtime gating:
     - à¸à¹ˆà¸­à¸™ inject â†’ check budget guard (maxCostPerCall)
     - à¸–à¹‰à¸² budget à¹ƒà¸à¸¥à¹‰à¸«à¸¡à¸” â†’ skip expensive skills
```

### F.3 â€” Hot Reload

```
Hot Reload System:

  â‘  File watcher (fs.watch / chokidar):
     - Watch: groups/*/skills/*/SKILL.md, skills/global/*/SKILL.md
     - Events: add, change, unlink
     
  â‘¡ On file change:
     - Re-parse SKILL.md
     - Re-validate prerequisites
     - Update skill registry
     - Log: "[skills] reloaded web-search v1.0.1 (was v1.0.0)"
     
  â‘¢ On file delete:
     - Remove from registry
     - Log: "[skills] unloaded web-search"
     
  â‘£ On new file:
     - Parse + validate + add to registry
     - Log: "[skills] loaded new skill: code-review v1.0.0"
  
  Debounce: 2 seconds (avoid rapid reloads during save)
  
  Error handling:
  - Invalid YAML â†’ log warning, keep previous version
  - Missing prerequisite â†’ mark skill as invalid, log reason
  - Syntax error in Markdown â†’ load anyway (best effort)
```

### F.4 â€” Plugin Hook System (Preview)

> **Note:** Full plugin system à¹€à¸›à¹‡à¸™ Phase 6 (BEYOND_OPENCLAW)  
> Phase 5 à¹€à¸•à¸£à¸µà¸¢à¸¡ hook points à¹„à¸§à¹‰à¸à¹ˆà¸­à¸™ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸—à¸³ full plugin loading

```
Lifecycle Hook Points (à¹ƒà¸Šà¹‰ MessageBus à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆ):

  messageBus.on('hook:before_agent_start', (ctx) => { ... });
  messageBus.on('hook:after_tool_call', (toolName, result) => { ... });
  messageBus.on('hook:message_received', (message) => { ... });
  messageBus.on('hook:message_sending', (response) => { ... });
  messageBus.on('hook:session_end', (summary) => { ... });

  Phase 5 scope:
  - âœ… Define hook event names
  - âœ… Emit hook events at correct points in pipeline
  - âœ… Document hook interface
  - âŒ Plugin file loading (Phase 6)
  - âŒ Plugin dependency resolution (Phase 6)
  - âŒ Plugin marketplace (Phase 6)
```

---

## Implementation Strategy

### File Map (à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸ªà¸£à¹‰à¸²à¸‡/à¹à¸à¹‰à¹„à¸‚)

```
à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸«à¸¡à¹ˆ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
nanoclaw/src/context-manager.ts      Part A â€” Context Monitor + Compaction + Pruning
nanoclaw/src/chunk-parser.ts         Part B â€” Streaming chunk parser
nanoclaw/src/status-manager.ts       Part B â€” Status indicator manager
nanoclaw/src/cost-intelligence.ts    Part C â€” Enhanced cost tracking + budget
nanoclaw/src/request-tracer.ts       Part D â€” Per-request tracing
nanoclaw/src/doctor.ts               Part D â€” Self-diagnosis service
nanoclaw/src/reply-shaper.ts         Part E â€” Output processing pipeline
nanoclaw/src/tool-sanitizer.ts       Part E â€” Tool result sanitization
nanoclaw/src/skill-loader.ts         Part F â€” Skill loading + hot-reload
oracle-v2/src/server/traces.ts       Part D â€” Trace API handlers
oracle-v2/src/server/quality.ts      Part D â€” Knowledge quality metrics

à¹à¸à¹‰à¹„à¸‚:
â”€â”€â”€â”€â”€â”€
nanoclaw/src/index.ts                Wire up new modules
nanoclaw/src/container-runner.ts     Streaming + chunk parsing + tracing
nanoclaw/src/inline-handler.ts       New commands: /usage, /cost, /budget, /doctor
nanoclaw/src/prompt-builder.ts       Skill injection + context management
nanoclaw/src/cost-tracker.ts         Migrate to cost-intelligence.ts
nanoclaw/src/logger.ts               Trace ID support + file transport
nanoclaw/src/config.ts               New config: context, streaming, budget, skills

oracle-v2/src/server.ts              Trace endpoints + quality endpoints
oracle-v2/src/db/schema.ts           Trace + quality tables

docker-compose.yml                   NanoClaw health check
container/agent-runner/              Chunk sentinel output

config/ (à¹ƒà¸«à¸¡à¹ˆ):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
config/model-pricing.json            Model pricing config
config/budgets.json                  Default budget config
skills/global/                       Global skills directory
```

### Test Strategy

```
Testing Approach per Part:

  Part A (Context Mastery):
  - Unit: ContextManager token estimation (Thai vs English)
  - Unit: pruneToolResults() correctness
  - Integration: compaction + Oracle store round-trip
  - E2E: 20-turn conversation â†’ verify compaction triggers
  
  Part B (Streaming):
  - Unit: ChunkParser state machine (all transitions)
  - Unit: block splitting (paragraph, code, bullet boundaries)
  - Integration: container â†’ parser â†’ mock channel
  - Manual: Telegram partial mode visual test
  
  Part C (Cost Intelligence):
  - Unit: budget threshold calculations
  - Unit: model auto-downgrade logic
  - Integration: budget enforcement across requests
  - Manual: /usage, /cost, /budget commands
  
  Part D (Observability):
  - Unit: RequestTracer span tracking
  - Unit: DoctorService health checks
  - Integration: trace storage + retrieval API
  - Integration: knowledge quality computation
  
  Part E (Agent Loop):
  - Unit: ReplyShaperPipeline (each step)
  - Unit: ToolResultSanitizer (each rule)
  - Unit: NO_REPLY detection
  - Unit: sensitive data redaction patterns
  
  Part F (Skills):
  - Unit: SKILL.md YAML parsing
  - Unit: prerequisite validation
  - Unit: gating logic
  - Integration: skill injection into prompt
  - Manual: hot-reload (add/modify/delete SKILL.md)
```

### Estimated Timeline

```
Wave 1 (Week 1): Independent foundations          ~5 days
  â”œâ”€â”€ Part C: Cost Intelligence                    2-3 days
  â”œâ”€â”€ Part D.1-D.3: Tracing + Health + Logging     2-3 days (parallel)
  â””â”€â”€ Part F: Skills System                        2-3 days (parallel)

Wave 2 (Week 2): Context + Quality                ~4 days
  â”œâ”€â”€ Part A.1-A.4: Context Monitor + Compaction   3-4 days
  â””â”€â”€ Part D.4-D.6: /doctor + Quality + Trace API  2 days (parallel)

Wave 3 (Week 3): Streaming                        ~5 days
  â”œâ”€â”€ Part B.1-B.3: Streaming Architecture         3 days
  â”œâ”€â”€ Part B.4-B.5: Channel integration            1-2 days
  â””â”€â”€ Part B.6: Status Indicators                  1 day

Wave 4 (Week 4): Agent Loop + Polish              ~3 days
  â”œâ”€â”€ Part E: Reply Shaping + Sanitization         2-3 days
  â”œâ”€â”€ Part A.5: Anticipatory Prefetch              1 day
  â””â”€â”€ Integration testing + bug fixes              1-2 days

Buffer: 3-5 days à¸ªà¸³à¸«à¸£à¸±à¸š unexpected issues

Total: ~4-5 à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ
```

### Risk Assessment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Risk                            â”‚  Impact  â”‚  Mitigation       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Streaming breaks existing       â”‚  ğŸ”´ High  â”‚  Feature flag     â”‚
â”‚  sentinel parsing                â”‚          â”‚  STREAMING=on/off  â”‚
â”‚                                  â”‚          â”‚                   â”‚
â”‚  Compaction summary quality      â”‚  ğŸŸ  Med   â”‚  Use structure    â”‚
â”‚  LLM output à¹„à¸¡à¹ˆà¸”à¸µà¸à¸­              â”‚          â”‚  prompt, validate  â”‚
â”‚                                  â”‚          â”‚                   â”‚
â”‚  Telegram rate limit during      â”‚  ğŸŸ¡ Low   â”‚  1 edit/sec       â”‚
â”‚  streaming                       â”‚          â”‚  throttle          â”‚
â”‚                                  â”‚          â”‚                   â”‚
â”‚  Budget enforcement blocks       â”‚  ğŸŸ  Med   â”‚  Graceful degrade â”‚
â”‚  legitimate requests             â”‚          â”‚  à¹„à¸¡à¹ˆ block à¸—à¸±à¸™à¸—à¸µ    â”‚
â”‚                                  â”‚          â”‚                   â”‚
â”‚  Skill YAML parsing edge cases   â”‚  ğŸŸ¡ Low   â”‚  Strict schema    â”‚
â”‚                                  â”‚          â”‚  validation + log  â”‚
â”‚                                  â”‚          â”‚                   â”‚
â”‚  Hot reload race conditions      â”‚  ğŸŸ¡ Low   â”‚  Debounce +       â”‚
â”‚                                  â”‚          â”‚  atomic swap       â”‚
â”‚                                  â”‚          â”‚                   â”‚
â”‚  Token estimation inaccurate     â”‚  ğŸŸ  Med   â”‚  Conservative     â”‚
â”‚  for mixed Thai/English          â”‚          â”‚  ratios, calibrate â”‚
â”‚                                  â”‚          â”‚  against actual    â”‚
â”‚                                  â”‚          â”‚                   â”‚
â”‚  Trace storage fills disk        â”‚  ğŸŸ¡ Low   â”‚  7-day retention  â”‚
â”‚                                  â”‚          â”‚  + daily cleanup   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Success Criteria

à¹€à¸¡à¸·à¹ˆà¸­ v0.8.0 deploy à¹€à¸ªà¸£à¹‡à¸ˆ à¸•à¹‰à¸­à¸‡à¸œà¹ˆà¸²à¸™à¸—à¸¸à¸à¸‚à¹‰à¸­:

| Test | Target | à¸§à¸´à¸˜à¸µà¸§à¸±à¸” |
|------|--------|---------|
| **Context survival** | No data loss in 50-turn conv | à¸ªà¸™à¸—à¸™à¸² 50 turns â†’ AI à¸ˆà¸³à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ turn 1-5 à¹„à¸”à¹‰à¸ˆà¸²à¸ compacted summary |
| **Streaming latency** | First byte < 3s | à¹€à¸§à¸¥à¸²à¸ˆà¸²à¸ user à¸ªà¹ˆà¸‡ â†’ user à¹€à¸«à¹‡à¸™ chunk à¹à¸£à¸ < 3 à¸§à¸´à¸™à¸²à¸—à¸µ |
| **Budget enforcement** | Auto-downgrade works | à¸•à¸±à¹‰à¸‡ budget $1 â†’ à¹ƒà¸Šà¹‰à¹€à¸à¸´à¸™ â†’ model switch to Haiku auto |
| **Cost accuracy** | Within 10% of actual | cost-tracker estimate vs actual API bill |
| **Trace coverage** | 100% requests traced | à¸—à¸¸à¸ request à¸¡à¸µ traceId + spans |
| **/doctor** | All checks pass | /doctor â†’ report à¹à¸ªà¸”à¸‡à¸—à¸¸à¸ service + metrics |
| **Quality metrics** | Health score > 80% | Knowledge quality dashboard > 80% |
| **Skill loading** | Hot-reload works | à¹€à¸à¸´à¹ˆà¸¡ SKILL.md â†’ agent à¹€à¸«à¹‡à¸™ skill à¸ à¸²à¸¢à¹ƒà¸™ 5s |
| **Reply shaping** | No raw artifacts | à¹„à¸¡à¹ˆà¸¡à¸µ sentinel markers / thinking blocks à¹ƒà¸™ user-facing output |
| **Tool sanitization** | Secrets redacted | Tool results à¹„à¸¡à¹ˆ expose API keys / passwords |
| **NO_REPLY** | Silent ops work | Memory flush â†’ user à¹„à¸¡à¹ˆà¹€à¸«à¹‡à¸™à¸­à¸°à¹„à¸£ |
| **NanoClaw health** | Docker-aware | docker compose ps â†’ nanoclaw healthy |

---

## Related Documents

| Document | Purpose |
|----------|---------|
| [BEYOND_OPENCLAW.md](BEYOND_OPENCLAW.md) | Master intelligence roadmap â€” Pillars 1-7 |
| [v0.7.0-phase4-memory-layers.md](v0.7.0-phase4-memory-layers.md) | Phase 4 implementation spec (prerequisite) |
| [MASTER_PLAN/README.md](MASTER_PLAN/README.md) | Original 6-phase master plan |
| [MASTER_PLAN/Phase_5_Production_Polish/](MASTER_PLAN/Phase_5_Production_Polish/) | Original Phase 5 items (Docker, encryption, monitoring) |

---

## Notes

### à¸„à¸§à¸²à¸¡à¹à¸•à¸à¸•à¹ˆà¸²à¸‡à¸ˆà¸²à¸ Phase 5 à¹€à¸”à¸´à¸¡ (MASTER_PLAN)

Phase 5 à¹€à¸”à¸´à¸¡à¹ƒà¸™ MASTER_PLAN à¹€à¸™à¹‰à¸™ "deployment infrastructure" (Docker Compose, encryption, monitoring, deploy script) à¸‹à¸¶à¹ˆà¸‡à¸ªà¹ˆà¸§à¸™à¹ƒà¸«à¸à¹ˆ **à¸—à¸³à¹„à¸›à¹à¸¥à¹‰à¸§** à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡ v0.5.0-v0.7.0:

| Item à¹€à¸”à¸´à¸¡ | à¸ªà¸–à¸²à¸™à¸° |
|-----------|--------|
| Docker Compose Production | âœ… à¸—à¸³à¹à¸¥à¹‰à¸§ (docker-compose.yml, 4 services) |
| Encrypted Volumes | â­ï¸ à¸‚à¹‰à¸²à¸¡à¹„à¸› (à¹ƒà¸Šà¹‰ Docker named volumes) |
| Monitoring & Health | ğŸ”§ Oracle à¸¡à¸µ /api/health, NanoClaw à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ |
| Deploy Script | â­ï¸ à¸‚à¹‰à¸²à¸¡à¹„à¸› (à¹ƒà¸Šà¹‰ docker compose up -d) |
| Documentation | ğŸ”§ à¸¡à¸µ QUICKSTART + DEPLOYMENT + API docs |
| Interactive Dashboard | âœ… à¸¡à¸µ React frontend à¹à¸¥à¹‰à¸§ |

**v0.8.0 Phase 5 à¹ƒà¸«à¸¡à¹ˆ** à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ focus à¹€à¸›à¹‡à¸™ "intelligence infrastructure" â€” à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰ AI à¸—à¸³à¸‡à¸²à¸™à¹„à¸”à¹‰à¸”à¸µà¸‚à¸¶à¹‰à¸™à¹ƒà¸™à¸Šà¸µà¸§à¸´à¸•à¸ˆà¸£à¸´à¸‡: context management, streaming, cost control, observability, extensibility

### Phase 6 (BEYOND_OPENCLAW) Preview

à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸ˆà¸°à¸—à¸³à¸•à¹ˆà¸­à¸«à¸¥à¸±à¸‡ v0.8.0:
- Memory Consolidation Service (daily batch: merge, deduplicate, extract patterns)
- Multi-Provider Failover Chain (Sonnet â†’ Haiku â†’ Ollama local)
- Auth Profile Rotation (multi-key per provider)
- Agent-to-Agent Swarm Coordination
- Query Expansion Engine (synonym + translation)
- Full Plugin System (file loading + dependency resolution)

---

> **à¸ªà¸£à¸¸à¸›:** v0.8.0 à¸„à¸·à¸­ "à¸—à¸³à¹ƒà¸«à¹‰ AI à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡à¹ƒà¸™à¸Šà¸µà¸§à¸´à¸•à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™" â€”  
> à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¹à¸„à¹ˆà¸‰à¸¥à¸²à¸” (v0.7.0 à¸—à¸³à¹à¸¥à¹‰à¸§) à¹à¸•à¹ˆà¸•à¹‰à¸­à¸‡ **à¸•à¸­à¸šà¹€à¸£à¹‡à¸§, à¸„à¸§à¸šà¸„à¸¸à¸¡à¸„à¹ˆà¸²à¹ƒà¸Šà¹‰à¸ˆà¹ˆà¸²à¸¢à¹„à¸”à¹‰,  
> debug à¹„à¸”à¹‰, à¸‚à¸¢à¸²à¸¢à¹„à¸”à¹‰** â€” à¸™à¸µà¹ˆà¸„à¸·à¸­ production-grade AI assistant
