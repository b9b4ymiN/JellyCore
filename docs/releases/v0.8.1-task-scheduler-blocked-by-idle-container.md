# v0.8.1 — Task Scheduler Blocked by Idle Container

**Date**: 2026-02-20  
**Severity**: Critical — scheduled tasks never fire while user is chatting  
**Status**: Fixed

---

## 1. สรุปปัญหา (Problem Summary)

ผู้ใช้ตั้ง one-time task ให้ทำงานตอน 20:25 น. แต่ task ไม่ทำงานตามเวลา  
Docker logs แสดง "Found due tasks count: 1" ตรงเวลา แต่ไม่มี log ของ "Running scheduled task" ตามมา

ปัญหาเดียวกันเกิดกับ task ที่สอง (20:35 น.) เช่นกัน — ไม่มีข้อความส่งถึงผู้ใช้

---

## 2. Root Cause Analysis

### Bug #1: Idle Container blocks task execution (CRITICAL)

**สาเหตุหลัก**: เมื่อผู้ใช้ส่งข้อความ container จะถูก spawn ขึ้นมาเพื่อตอบกลับ  
หลังจากตอบเสร็จ container ไม่ได้ถูกปิดทันที — มันรอ **IDLE_TIMEOUT = 30 นาที** ก่อนจะปิดตัวเอง

GroupQueue ทำงานแบบ **one-at-a-time per group**: ถ้า group มี container ที่กำลัง active อยู่  
task ใหม่จะถูก push เข้า `pendingTasks` queue และรอจนกว่า container ปัจจุบันจะจบ

#### Timeline ของปัญหา:
```
20:22:40  Container spawned สำหรับข้อความผู้ใช้
20:23:17  Agent ตอบกลับ → idle timer เริ่มนับ 30 นาที
20:25:01  Scheduler พบ due task → claim สำเร็จ → enqueueTask()
          ↳ group active = true → task ถูก push เข้า pendingTasks
          ↳ task ติดค้างอยู่ใน queue!
20:27:28  ผู้ใช้ส่งข้อความใหม่ → pendingMessages = true
          ↳ container ยังทำงานอยู่ รับ follow-up message ได้
20:29:55  Agent ตอบกลับ → idle timer RESET อีก 30 นาที
20:31:08  ผู้ใช้ส่งข้อความอีก → idle timer RESET อีกครั้ง
          ...
          Task ติดค้างจนกว่า container จะปิด (~30 นาทีหลังข้อความสุดท้าย)
```

**ผลกระทบ**: ทุกครั้งที่ผู้ใช้ส่งข้อความ idle timer จะ reset เป็น 30 นาทีใหม่  
ถ้าผู้ใช้คุยต่อเนื่อง task อาจไม่ทำงานเลย

#### Root in Code:

**`group-queue.ts`** — `enqueueTask()`:
```typescript
if (state.active) {
    state.pendingTasks.push({ id: taskId, groupJid, fn });
    // task waits indefinitely until container finishes!
    return;
}
```

**`index.ts`** — Idle timer resets on every output:
```typescript
const resetIdleTimer = () => {
    if (idleTimer) clearTimeout(idleTimer);
    idleTimer = setTimeout(() => {
        queue.closeStdin(chatJid);  // only closes after 30 MINUTES of silence
    }, IDLE_TIMEOUT);  // IDLE_TIMEOUT = 1,800,000 ms (30 min)
};
```

### Bug #2: Task created by agent writing file directly (not via MCP)

ตัว Agent บอกผู้ใช้ว่า task แรก (task-1771593787910) "ถูกปฏิเสธโดย host เนื่องจาก MCP bug"  
ซึ่งเป็น **hallucination** — task แรกถูกสร้างสำเร็จ (มี log "Task created via IPC")  
แต่ ID ไม่ตรง: Agent แจ้ง `task-1771593787910` แต่ host สร้างเป็น `task-1771593788014-kfi1mx`

Task ที่สอง agent เขียนไฟล์ลง IPC directory โดยตรง ด้วย ID ที่กำหนดเอง (`task-1771593700000-test35`)  
ซึ่งอาจไม่ผ่าน IPC signing verification → host ปฏิเสธ → ไม่มี log "Task created via IPC" สำหรับ task นี้

### Bug #3: Task ID mismatch between MCP tool and host

MCP tool (`schedule_task`) ไม่ได้สร้าง task ID — มันส่งข้อมูลไปที่ host ผ่าน IPC  
แต่ host เป็นคนสร้าง ID จริง (ด้วย timestamp ของ host)  
Agent จึงไม่รู้ ID จริงของ task → แจ้งผู้ใช้ด้วย ID ที่ไม่ถูกต้อง → ไม่สามารถ reference task ได้

---

## 3. Solutions

### Fix #1: Preempt idle container when tasks are pending

เมื่อ scheduler พบ due tasks และ group มี container ที่กำลัง idle  
→ ปิด container ทันที (closeStdin) เพื่อให้ task ทำงานได้

**Implementation**:
- เพิ่ม method `hasPendingTasks()` ใน GroupQueue
- เพิ่ม method `preemptIdleContainer()` ที่ส่ง `_close` sentinel
- Scheduler loop เรียก `preemptIdleContainer()` เมื่อมี due tasks ที่ group active

### Fix #2: Reduce idle timeout when tasks are queued

เมื่อ task ถูก enqueue ขณะที่ group active → ลด idle timeout เหลือ 5 วินาที  
เพื่อให้ container ปิดเร็วขึ้นและ task ทำงานได้เร็ว

**Implementation**:
- `enqueueTask()` ตรวจสอบ `state.active` → ถ้า active ให้เรียก `closeStdin()`
  เพื่อบอก container ที่กำลัง idle ให้หยุดทำงาน

### Fix #3: Return task ID to MCP tool via IPC feedback

ส่ง task ID กลับไปให้ container ผ่าน IPC feedback file  
เพื่อให้ agent รู้ ID จริงของ task ที่ถูกสร้าง

---

## 4. Files Changed

| File | Change |
|------|--------|
| `nanoclaw/src/group-queue.ts` | Added `preemptForPendingTasks()` — closes idle container when tasks are waiting |
| `nanoclaw/src/task-scheduler.ts` | Call `queue.preemptForPendingTasks()` after enqueuing tasks |
| `nanoclaw/src/ipc.ts` | Write task ID feedback file after task creation |

---

## 5. Testing

```
# Run all tests
cd nanoclaw && npx vitest run

# Specific scenario to test:
# 1. Start container for message processing
# 2. While container is idle, schedule a task
# 3. Verify task executes within seconds, not 30 minutes
```
